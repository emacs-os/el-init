# Maintainer: Static Emacs Project
# Full-featured static emacs-nox — closest to stock Arch emacs-nox
#
# Based on the official Arch Linux emacs PKGBUILD.
# This PKGBUILD produces a fully statically linked emacs-nox binary with
# the maximum feature set achievable through static linking.
#
# No source patches required — static linking is achieved entirely through
# configure flags and building static versions of dependencies.
#
# Stock emacs-nox configure flags (Arch):
#   --without-x --without-sound --with-cairo --with-harfbuzz
#   --with-libsystemd --with-modules --with-native-compilation=aot
#   --with-tree-sitter
#
# Feature comparison vs stock emacs-nox:
#   RETAINED:  GMP, GnuTLS, libxml2, tree-sitter, modules, threads,
#              zlib, pdumper, inotify, ncurses
#   DISABLED:  native-compilation (no libgccjit.a exists),
#              D-Bus (needs static libdbus), libsystemd (needs static lib),
#              GPM (needs static libgpm), lcms2 (needs static liblcms2),
#              ACL (needs static libacl), selinux, cairo, harfbuzz
#
# Runtime note: tree-sitter grammar loading and dynamic modules use dlopen()
# which works in glibc 2.28+ static binaries (files/dns NSS built into libc.a).
# Grammar .so files must be available on the system at runtime.

pkgname=emacs-nox-static
pkgver=30.2
pkgrel=1
pkgdesc='GNU Emacs (nox) — fully statically linked, full-featured'
arch=('x86_64')
url='https://www.gnu.org/software/emacs/emacs.html'
license=('GPL3')
depends=()  # none — it's static
# Runtime optional: tree-sitter grammar packages (e.g. tree-sitter-c) for
# tree-sitter functionality. These are .so files loaded via dlopen at runtime.
optdepends=(
  'tree-sitter-grammars: tree-sitter language grammars'
)
makedepends=(
  gcc
  make
  autoconf
  automake
  texinfo
  glibc      # for libc.a, libm.a, etc.
  zlib        # for libz.a
)
provides=(emacs)
conflicts=(emacs)
source=(
  "https://ftp.gnu.org/gnu/emacs/emacs-${pkgver}.tar.xz"
  "https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.5.tar.gz"
  "https://ftp.gnu.org/pub/gnu/gmp/gmp-6.3.0.tar.xz"
  "https://ftp.gnu.org/pub/gnu/nettle/nettle-3.10.1.tar.gz"
  "https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.9.tar.xz"
  "https://download.gnome.org/sources/libxml2/2.15/libxml2-2.15.1.tar.xz"
  "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.25.6.tar.gz"
)
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

prepare() {
  _static_prefix="${srcdir}/static-libs"

  # ── Build static ncurses (wide-char) ──
  cd "${srcdir}/ncurses-6.5"
  ./configure --prefix="${_static_prefix}" \
    --with-normal --without-shared --without-debug \
    --without-cxx --without-cxx-binding --enable-widec \
    --without-ada --without-manpages --without-tests
  make -j$(nproc)
  make install
  cd "${_static_prefix}/lib"
  ln -sf libncursesw.a libncurses.a
  ln -sf libncursesw.a libtinfo.a
  ln -sf libncursesw.a libtinfow.a

  # ── Build static GMP ──
  cd "${srcdir}/gmp-6.3.0"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared CC="gcc -std=gnu17"
  make -j$(nproc)
  make install

  # CRITICAL: Remove spurious config.h from GMP install
  rm -f "${_static_prefix}/include/config.h"

  # ── Build static nettle (produces libnettle.a + libhogweed.a) ──
  cd "${srcdir}/nettle-3.10.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-documentation --disable-openssl \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static GnuTLS ──
  cd "${srcdir}/gnutls-3.8.9"
  PKG_CONFIG_PATH="${_static_prefix}/lib/pkgconfig" \
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-cxx --disable-tools --disable-doc \
    --disable-libdane --disable-guile --disable-nls \
    --without-p11-kit --without-idn --without-brotli --without-zstd \
    --without-tpm --with-tpm2=no \
    --with-included-unistring --with-included-libtasn1 \
    --disable-hardware-acceleration \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include" \
    GMP_LIBS="-L${_static_prefix}/lib -lgmp" \
    GMP_CFLAGS="-I${_static_prefix}/include" \
    NETTLE_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    NETTLE_CFLAGS="-I${_static_prefix}/include" \
    HOGWEED_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    HOGWEED_CFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static libxml2 (without ICU to minimize deps) ──
  cd "${srcdir}/libxml2-2.15.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --without-python --without-icu --without-lzma \
    --without-readline --without-http \
    CFLAGS="-O2"
  make -j$(nproc)
  make install

  # ── Build static tree-sitter ──
  cd "${srcdir}/tree-sitter-0.25.6"
  make PREFIX="${_static_prefix}" -j$(nproc)
  make PREFIX="${_static_prefix}" install

  # Final cleanup — ensure no spurious config.h
  rm -f "${_static_prefix}/include/config.h"
}

build() {
  _static_prefix="${srcdir}/static-libs"
  cd "emacs-${pkgver}"

  # PKG_CONFIG=false prevents detection of libseccomp (no --without-seccomp exists)
  # -Wl,--allow-multiple-definition resolves GnuTLS gnulib vs Emacs symbol collisions
  PKG_CONFIG=false ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --libexecdir=/usr/lib \
    --localstatedir=/var \
    --without-all \
    --without-x \
    --without-sound \
    --without-dbus \
    --without-libsystemd \
    --without-compress-install \
    --without-native-compilation \
    --without-selinux \
    --without-gpm \
    --without-lcms2 \
    --with-modules \
    --with-threads \
    --with-zlib \
    --with-xml2=yes \
    --with-gnutls=yes \
    --with-tree-sitter=yes \
    --with-pdumper=yes \
    --with-dumping=pdumper \
    --with-file-notification=inotify \
    CFLAGS="-O2 -std=gnu17 -I${_static_prefix}/include -I${_static_prefix}/include/ncursesw" \
    LDFLAGS="-static -no-pie -L${_static_prefix}/lib -Wl,--allow-multiple-definition" \
    CPPFLAGS="-I${_static_prefix}/include -I${_static_prefix}/include/ncursesw" \
    LIBXML2_CFLAGS="-I${_static_prefix}/include/libxml2" \
    LIBXML2_LIBS="-L${_static_prefix}/lib -lxml2 -lz -lm" \
    LIBGNUTLS_CFLAGS="-I${_static_prefix}/include" \
    LIBGNUTLS_LIBS="-L${_static_prefix}/lib -lgnutls -lhogweed -lnettle -lgmp" \
    TREE_SITTER_CFLAGS="-I${_static_prefix}/include" \
    TREE_SITTER_LIBS="-L${_static_prefix}/lib -ltree-sitter"

  make -j$(nproc)
}

check() {
  cd "emacs-${pkgver}"
  local binary="src/emacs"

  echo "=== Static linkage verification ==="
  file "$binary"
  ldd "$binary" 2>&1 | grep -q "not a dynamic executable" || { echo "FAIL: not static"; return 1; }
  readelf -d "$binary" 2>/dev/null | grep -q NEEDED && { echo "FAIL: has NEEDED entries"; return 1; }
  readelf -l "$binary" 2>/dev/null | grep -q INTERP && { echo "FAIL: has INTERP"; return 1; }

  # Verify it runs and features are enabled
  ./src/emacs --version
  ./src/emacs --batch --eval '(message "%s" system-configuration-features)' 2>&1
  ./src/emacs --batch --eval '(message "GnuTLS: %s" (gnutls-available-p))' 2>&1
  ./src/emacs --batch --eval '(message "tree-sitter: %s" (treesit-available-p))' 2>&1
  echo "PASS: Full-featured static emacs-nox binary verified"
}

package() {
  cd "emacs-${pkgver}"
  make DESTDIR="${pkgdir}" install

  # Remove conflict with ctags package (matches stock Arch PKGBUILD)
  mv "${pkgdir}"/usr/bin/{ctags,ctags.emacs}
  if [ -f "${pkgdir}/usr/share/man/man1/ctags.1.gz" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1.gz,ctags.emacs.1.gz}
  elif [ -f "${pkgdir}/usr/share/man/man1/ctags.1" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1,ctags.emacs.1}
  fi
}
