# Maintainer: Static Emacs Project
# Full-featured static emacs-nox with native-compilation
#
# Based on the official Arch Linux emacs PKGBUILD (emacs-nox variant).
# This PKGBUILD produces a fully statically linked emacs-nox binary with
# native-compilation (nativecomp/AOT) support — the maximum achievable
# feature set for a static terminal Emacs.
#
# BUILD TIME: ~45-60 minutes (GCC build dominates)
#
# This builds GCC from source to obtain libgccjit.a, which is not shipped
# by any Linux distribution. The GCC build adds ~20-30 minutes but produces
# a self-contained static binary with JIT compilation capability.
#
# No source patches required — static linking is achieved entirely through
# configure flags and building static versions of dependencies.
#
# Feature comparison vs stock emacs-nox:
#   RETAINED:  GMP, GnuTLS, libxml2, tree-sitter, modules, threads,
#              zlib, pdumper, inotify, ncurses, NATIVE-COMPILATION
#   DISABLED:  D-Bus, libsystemd, GPM, lcms2, ACL, selinux,
#              cairo, harfbuzz
#
# Runtime notes:
#   - tree-sitter grammars (.so) loaded via dlopen at runtime
#   - Native-compiled .eln files produced at runtime via embedded JIT
#   - Dynamic modules use dlopen (works in glibc 2.28+ static binaries)
#   - The JIT needs 'as' and 'ld' at runtime (from binutils, normally installed)
#   - Binary is ~376MB (includes entire GCC compiler backend)

pkgname=emacs-nox-static-nativecomp
pkgver=30.2
pkgrel=1
pkgdesc='GNU Emacs (nox) — fully static with native-compilation'
arch=('x86_64')
url='https://www.gnu.org/software/emacs/emacs.html'
license=('GPL3')
depends=()  # none — it's static
optdepends=(
  'tree-sitter-grammars: tree-sitter language grammars'
  'binutils: required for native-compilation at runtime (as, ld)'
)
makedepends=(
  gcc
  make
  autoconf
  automake
  texinfo
  flex
  bison
  glibc      # for libc.a, libm.a, etc.
  zlib        # for libz.a
)
provides=(emacs)
conflicts=(emacs)

_gcc_ver=15.1.0

source=(
  "https://ftp.gnu.org/gnu/emacs/emacs-${pkgver}.tar.xz"
  "https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.5.tar.gz"
  "https://ftp.gnu.org/pub/gnu/gmp/gmp-6.3.0.tar.xz"
  "https://ftp.gnu.org/pub/gnu/nettle/nettle-3.10.1.tar.gz"
  "https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.9.tar.xz"
  "https://download.gnome.org/sources/libxml2/2.15/libxml2-2.15.1.tar.xz"
  "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.25.6.tar.gz"
  "https://github.com/facebook/zstd/releases/download/v1.5.7/zstd-1.5.7.tar.gz"
  "https://ftp.gnu.org/gnu/gcc/gcc-${_gcc_ver}/gcc-${_gcc_ver}.tar.xz"
)
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

prepare() {
  _static_prefix="${srcdir}/static-libs"

  # ── Build static ncurses (wide-char) ──
  cd "${srcdir}/ncurses-6.5"
  ./configure --prefix="${_static_prefix}" \
    --with-normal --without-shared --without-debug \
    --without-cxx --without-cxx-binding --enable-widec \
    --without-ada --without-manpages --without-tests
  make -j$(nproc)
  make install
  cd "${_static_prefix}/lib"
  ln -sf libncursesw.a libncurses.a
  ln -sf libncursesw.a libtinfo.a
  ln -sf libncursesw.a libtinfow.a

  # ── Build static GMP ──
  cd "${srcdir}/gmp-6.3.0"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared CC="gcc -std=gnu17"
  make -j$(nproc)
  make install
  # CRITICAL: Remove spurious config.h from GMP install
  rm -f "${_static_prefix}/include/config.h"

  # ── Build static nettle ──
  cd "${srcdir}/nettle-3.10.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-documentation --disable-openssl \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static GnuTLS ──
  cd "${srcdir}/gnutls-3.8.9"
  PKG_CONFIG_PATH="${_static_prefix}/lib/pkgconfig" \
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-cxx --disable-tools --disable-doc \
    --disable-libdane --disable-guile --disable-nls \
    --without-p11-kit --without-idn --without-brotli --without-zstd \
    --without-tpm --with-tpm2=no \
    --with-included-unistring --with-included-libtasn1 \
    --disable-hardware-acceleration \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include" \
    GMP_LIBS="-L${_static_prefix}/lib -lgmp" \
    GMP_CFLAGS="-I${_static_prefix}/include" \
    NETTLE_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    NETTLE_CFLAGS="-I${_static_prefix}/include" \
    HOGWEED_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    HOGWEED_CFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static libxml2 ──
  cd "${srcdir}/libxml2-2.15.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --without-python --without-icu --without-lzma \
    --without-readline --without-http \
    CFLAGS="-O2"
  make -j$(nproc)
  make install

  # ── Build static tree-sitter ──
  cd "${srcdir}/tree-sitter-0.25.6"
  make PREFIX="${_static_prefix}" -j$(nproc)
  make PREFIX="${_static_prefix}" install

  # ── Build static zstd (needed by GCC LTO) ──
  cd "${srcdir}/zstd-1.5.7/lib"
  make -j$(nproc) libzstd.a
  cp libzstd.a "${_static_prefix}/lib/"

  # ── Build GCC from source for libgccjit.a ──
  # This is the most time-consuming step (~10-30 min depending on cores).
  # No distribution ships libgccjit.a — only libgccjit.so.
  # We build GCC with JIT support and extract a static archive.
  cd "${srcdir}/gcc-${_gcc_ver}"
  ./contrib/download_prerequisites
  mkdir -p build && cd build
  ../configure \
    --prefix="${_static_prefix}/gcc" \
    --enable-languages=c,c++,jit,lto \
    --enable-host-shared \
    --disable-bootstrap \
    --disable-multilib \
    --disable-libsanitizer \
    --disable-libvtv \
    --disable-libgomp \
    --disable-libquadmath-support \
    --disable-libssp \
    --disable-libstdcxx-pch \
    --with-system-zlib
  make -j$(nproc)
  # Install GCC to its prefix (needed for JIT runtime smoke test and
  # for the JIT to find crtbeginS.o, libgcc, as, ld at runtime)
  make install

  # ── Create libgccjit.a from the GCC build tree ──
  # libgccjit.so is composed of these internal archives + JIT objects:
  #   - libbackend.a (GCC compiler backend)
  #   - libcommon-target.a, libcommon.a (common code)
  #   - libcpp.a (C preprocessor)
  #   - libdecnumber.a (decimal arithmetic)
  #   - libbacktrace.a (backtrace support)
  #   - libiberty.a (utility functions)
  #   - jit/*.o, attribs.o, gcc.o, driver-i386.o (JIT frontend + driver)
  local _gcc_build="${srcdir}/gcc-${_gcc_ver}/build"
  local _jit_tmp="${srcdir}/jit_objects"
  rm -rf "${_jit_tmp}"
  mkdir -p "${_jit_tmp}"

  # Extract objects from GCC's internal thin archives with unique prefixes
  # to avoid filename collisions between archives (e.g., sort.o exists in
  # both libcommon.a and libbacktrace.a with different contents)
  for archive in \
    "${_gcc_build}/gcc/libbackend.a" \
    "${_gcc_build}/gcc/libcommon-target.a" \
    "${_gcc_build}/gcc/libcommon.a" \
    "${_gcc_build}/libcpp/libcpp.a" \
    "${_gcc_build}/libdecnumber/libdecnumber.a" \
    "${_gcc_build}/libbacktrace/.libs/libbacktrace.a" \
    "${_gcc_build}/libiberty/pic/libiberty.a"; do
    if [ ! -f "$archive" ]; then
      echo "WARNING: Expected archive not found: $archive"
      continue
    fi
    local _adir _aname
    _adir=$(dirname "$archive")
    _aname=$(basename "$archive" .a)

    ar t "$archive" | while read -r obj; do
      local _fullpath
      if [[ "$obj" = /* ]]; then
        _fullpath="$obj"
      else
        _fullpath="${_adir}/${obj}"
      fi
      if [ -f "$_fullpath" ]; then
        # Skip ggc-none.o from libcommon — the JIT needs ggc-page.o from
        # libbackend instead (ggc-none is the no-op GC for the driver, not JIT)
        case "$obj" in *ggc-none*) continue ;; esac
        # Prefix with archive name and sanitize path to ensure uniqueness
        local _safename="${_aname}__$(echo "$obj" | tr '/' '__')"
        cp "$_fullpath" "${_jit_tmp}/${_safename}"
      fi
    done
  done

  # Add standalone JIT objects not in any archive
  for obj in \
    "${_gcc_build}/gcc/attribs.o" \
    "${_gcc_build}/gcc/gcc.o" \
    "${_gcc_build}/gcc/driver-i386.o" \
    "${_gcc_build}/gcc/common/common-targhooks.o" \
    "${_gcc_build}/gcc/jit/dummy-frontend.o" \
    "${_gcc_build}/gcc/jit/libgccjit.o" \
    "${_gcc_build}/gcc/jit/jit-logging.o" \
    "${_gcc_build}/gcc/jit/jit-recording.o" \
    "${_gcc_build}/gcc/jit/jit-playback.o" \
    "${_gcc_build}/gcc/jit/jit-result.o" \
    "${_gcc_build}/gcc/jit/jit-tempdir.o" \
    "${_gcc_build}/gcc/jit/jit-builtins.o" \
    "${_gcc_build}/gcc/jit/jit-spec.o"; do
    if [ -f "$obj" ]; then
      local _dirname _basename
      _dirname=$(basename "$(dirname "$obj")")
      _basename=$(basename "$obj")
      cp "$obj" "${_jit_tmp}/standalone__${_dirname}__${_basename}"
    fi
  done

  # Add text-art objects (GCC 15+ diagnostic rendering)
  for obj in "${_gcc_build}"/gcc/text-art/*.o; do
    if [ -f "$obj" ]; then
      local _basename
      _basename=$(basename "$obj")
      cp "$obj" "${_jit_tmp}/standalone__text-art__${_basename}"
    fi
  done

  # Create the combined static archive
  ar rcs "${_static_prefix}/lib/libgccjit.a" "${_jit_tmp}"/*.o
  echo "Created libgccjit.a: $(du -h "${_static_prefix}/lib/libgccjit.a" | cut -f1)"

  # Install GCC's internal GMP/MPFR/MPC/ISL static libs
  # (needed at link time for libgccjit's internal dependencies)
  cp "${_gcc_build}/gmp/.libs/libgmp.a" "${_static_prefix}/lib/libgccjit_gmp.a"
  cp "${_gcc_build}/mpfr/src/.libs/libmpfr.a" "${_static_prefix}/lib/libgccjit_mpfr.a"
  cp "${_gcc_build}/mpc/src/.libs/libmpc.a" "${_static_prefix}/lib/libgccjit_mpc.a"
  cp "${_gcc_build}/isl/.libs/libisl.a" "${_static_prefix}/lib/libgccjit_isl.a"

  # Copy libgccjit.h header
  cp "${srcdir}/gcc-${_gcc_ver}/gcc/jit/libgccjit.h" "${_static_prefix}/include/"
  cp "${srcdir}/gcc-${_gcc_ver}/gcc/jit/libgccjit++.h" "${_static_prefix}/include/" 2>/dev/null || true

  # Final cleanup — remove GMP's spurious config.h if recreated
  rm -f "${_static_prefix}/include/config.h"
}

build() {
  _static_prefix="${srcdir}/static-libs"
  cd "emacs-${pkgver}"

  # Set up paths so configure's JIT smoke test can find our GCC runtime
  # (crtbeginS.o, libgcc, as, ld) — the JIT actually compiles and runs
  # code during configure to verify it works.
  export PATH="${_static_prefix}/gcc/bin:${PATH}"

  # PKG_CONFIG=false prevents detection of libseccomp (no --without-seccomp)
  # -Wl,--allow-multiple-definition resolves GnuTLS gnulib ↔ Emacs symbol collisions
  # (hash_lookup, hash_string defined in both)
  #
  # LIBS= provides the full libgccjit dependency chain in a link group so that
  # the AC_CHECK_LIB configure test passes with static linking.
  #
  # LIBGCCJIT_LIBS is NOT set here because configure.ac hardcodes it to
  # "-lgccjit -ldl" regardless of what we pass. We override it at make time.
  PKG_CONFIG=false ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --libexecdir=/usr/lib \
    --localstatedir=/var \
    --without-all \
    --without-x \
    --without-sound \
    --without-dbus \
    --without-libsystemd \
    --without-compress-install \
    --without-selinux \
    --without-gpm \
    --without-lcms2 \
    --with-modules \
    --with-threads \
    --with-zlib \
    --with-xml2=yes \
    --with-gnutls=yes \
    --with-tree-sitter=yes \
    --with-native-compilation \
    --with-pdumper=yes \
    --with-dumping=pdumper \
    --with-file-notification=inotify \
    CC="gcc -std=gnu17" \
    CFLAGS="-O2 -I${_static_prefix}/include -I${_static_prefix}/include/ncursesw -I${_static_prefix}/gcc/include" \
    LDFLAGS="-static -no-pie -L${_static_prefix}/lib -L${_static_prefix}/gcc/lib64 -L${_static_prefix}/gcc/lib -Wl,--allow-multiple-definition" \
    LIBS="-Wl,--start-group -lgccjit -lgccjit_isl -lgccjit_mpc -lgccjit_mpfr -lgccjit_gmp -lzstd -lstdc++ -lz -lm -ldl -lpthread -Wl,--end-group" \
    LIBGNUTLS_CFLAGS="-I${_static_prefix}/include" \
    LIBGNUTLS_LIBS="-lgnutls -lhogweed -lnettle -lgmp" \
    LIBXML2_CFLAGS="-I${_static_prefix}/include/libxml2" \
    LIBXML2_LIBS="-lxml2 -lz -lm" \
    TREE_SITTER_CFLAGS="-I${_static_prefix}/include" \
    TREE_SITTER_LIBS="-ltree-sitter"

  # Override LIBGCCJIT_LIBS at make time with the full static dependency chain.
  # configure.ac hardcodes LIBGCCJIT_LIBS="-lgccjit -ldl" which is insufficient
  # for static linking — the 2GB libgccjit.a needs GMP, MPFR, MPC, ISL, zstd,
  # and the C++ runtime, all in a link group to resolve circular dependencies.
  make -j$(nproc) \
    LIBGCCJIT_LIBS="-Wl,--start-group -lgccjit -lgccjit_isl -lgccjit_mpc -lgccjit_mpfr -lgccjit_gmp -lzstd -lstdc++ -lz -lm -ldl -lpthread -Wl,--end-group"
}

check() {
  cd "emacs-${pkgver}"
  local binary="src/emacs"

  echo "=== Static linkage verification ==="
  file "$binary"
  ldd "$binary" 2>&1 | grep -q "not a dynamic executable" || { echo "FAIL: not static"; return 1; }
  readelf -d "$binary" 2>/dev/null | grep -q NEEDED && { echo "FAIL: has NEEDED entries"; return 1; }
  readelf -l "$binary" 2>/dev/null | grep -q INTERP && { echo "FAIL: has INTERP"; return 1; }

  # Verify features
  ./src/emacs --version
  local features
  features=$(./src/emacs --batch --eval '(message "%s" system-configuration-features)' 2>&1)
  echo "Features: $features"

  echo "$features" | grep -q "NATIVE_COMP" || { echo "FAIL: native-comp not enabled"; return 1; }
  echo "$features" | grep -q "GNUTLS" || { echo "FAIL: GnuTLS not enabled"; return 1; }
  echo "$features" | grep -q "TREE_SITTER" || { echo "FAIL: tree-sitter not enabled"; return 1; }
  echo "$features" | grep -q "MODULES" || { echo "FAIL: modules not enabled"; return 1; }

  echo "PASS: Static emacs-nox-nativecomp binary verified"
}

package() {
  cd "emacs-${pkgver}"
  make DESTDIR="${pkgdir}" install

  # Remove conflict with ctags package
  mv "${pkgdir}"/usr/bin/{ctags,ctags.emacs}
  if [ -f "${pkgdir}/usr/share/man/man1/ctags.1.gz" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1.gz,ctags.emacs.1.gz}
  elif [ -f "${pkgdir}/usr/share/man/man1/ctags.1" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1,ctags.emacs.1}
  fi
}
