# Maintainer: Static Emacs Project
# Full-featured static emacs-nox with PID1 patches
#
# The six original variants (minimal, full, nativecomp x Arch/Nix) are
# untouched legacy variants; this file is an additive new variant.
#
# This variant extends PKGBUILD-static-nox with PID1 Emacs patches:
#   --pid1 flag, signal handling, child reaping, pid1-boot-hook,
#   pid1-poweroff-hook, pid1-reboot-hook
#
# The -patched-for-pid1 suffix is a CAPABILITY marker: the binary supports
# --pid1 mode but does NOT activate it unless --pid1 is explicitly passed.
# Normal Emacs usage (without --pid1) is completely unchanged.
#
# This package ships PID1 capability only.  It does NOT bundle el-init,
# C helpers, or autostart wiring.  Administrators must provide their own
# startup configuration (early-init.el / init.el) and helper binaries.
#
# Feature set (same as PKGBUILD-static-nox):
#   GMP, GnuTLS, libxml2, tree-sitter, modules, threads, zlib, pdumper,
#   inotify, ncurses
# Additional PID1 features:
#   --pid1 flag, pid1-mode variable, pid1-boot-hook, pid1-poweroff-hook,
#   pid1-reboot-hook, automatic child reaping, signal handling
#   (SIGTERM/SIGUSR1->poweroff, SIGINT/SIGUSR2->reboot, SIGHUP->ignored)

pkgname=emacs-nox-static-elinit-patched-for-pid1
pkgver=30.2
pkgrel=1
pkgdesc='GNU Emacs (nox) -- static, full-featured, PID1 patched'
arch=('x86_64')
url='https://www.gnu.org/software/emacs/emacs.html'
license=('GPL3')
depends=()  # none — it's static
optdepends=(
  'tree-sitter-grammars: tree-sitter language grammars'
)
makedepends=(
  gcc
  make
  autoconf
  automake
  texinfo
  glibc
  zlib
)
provides=(emacs)
conflicts=(emacs)
source=(
  "https://ftp.gnu.org/gnu/emacs/emacs-${pkgver}.tar.xz"
  "https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.5.tar.gz"
  "https://ftp.gnu.org/pub/gnu/gmp/gmp-6.3.0.tar.xz"
  "https://ftp.gnu.org/pub/gnu/nettle/nettle-3.10.1.tar.gz"
  "https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.9.tar.xz"
  "https://download.gnome.org/sources/libxml2/2.15/libxml2-2.15.1.tar.xz"
  "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.25.6.tar.gz"
)
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

prepare() {
  _static_prefix="${srcdir}/static-libs"

  # ── Apply PID1 patches to Emacs source (pinned to documented artifacts) ──
  cd "${srcdir}/emacs-${pkgver}"
  for _patch in \
    "${startdir}/patches/emacs-0001-add-pid1-runtime-mode.patch" \
    "${startdir}/patches/emacs-0002-pid1-hooks-and-signals.patch" \
    "${startdir}/patches/emacs-0003-fix-pid1-signal-handler-overrides.patch"; do
    msg2 "Applying $(basename "$_patch")..."
    patch -Np1 < "$_patch"
  done

  # ── Build static ncurses (wide-char) ──
  cd "${srcdir}/ncurses-6.5"
  ./configure --prefix="${_static_prefix}" \
    --with-normal --without-shared --without-debug \
    --without-cxx --without-cxx-binding --enable-widec \
    --without-ada --without-manpages --without-tests
  make -j$(nproc)
  make install
  cd "${_static_prefix}/lib"
  ln -sf libncursesw.a libncurses.a
  ln -sf libncursesw.a libtinfo.a
  ln -sf libncursesw.a libtinfow.a

  # ── Build static GMP ──
  cd "${srcdir}/gmp-6.3.0"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared CC="gcc -std=gnu17"
  make -j$(nproc)
  make install
  rm -f "${_static_prefix}/include/config.h"

  # ── Build static nettle ──
  cd "${srcdir}/nettle-3.10.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-documentation --disable-openssl \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static GnuTLS ──
  cd "${srcdir}/gnutls-3.8.9"
  PKG_CONFIG_PATH="${_static_prefix}/lib/pkgconfig" \
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-cxx --disable-tools --disable-doc \
    --disable-libdane --disable-guile --disable-nls \
    --without-p11-kit --without-idn --without-brotli --without-zstd \
    --without-tpm --with-tpm2=no \
    --with-included-unistring --with-included-libtasn1 \
    --disable-hardware-acceleration \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include" \
    GMP_LIBS="-L${_static_prefix}/lib -lgmp" \
    GMP_CFLAGS="-I${_static_prefix}/include" \
    NETTLE_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    NETTLE_CFLAGS="-I${_static_prefix}/include" \
    HOGWEED_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    HOGWEED_CFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static libxml2 ──
  cd "${srcdir}/libxml2-2.15.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --without-python --without-icu --without-lzma \
    --without-readline --without-http \
    CFLAGS="-O2"
  make -j$(nproc)
  make install

  # ── Build static tree-sitter ──
  cd "${srcdir}/tree-sitter-0.25.6"
  make PREFIX="${_static_prefix}" -j$(nproc)
  make PREFIX="${_static_prefix}" install

  rm -f "${_static_prefix}/include/config.h"
}

build() {
  _static_prefix="${srcdir}/static-libs"
  cd "emacs-${pkgver}"

  PKG_CONFIG=false ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --libexecdir=/usr/lib \
    --localstatedir=/var \
    --without-all \
    --without-x \
    --without-sound \
    --without-dbus \
    --without-libsystemd \
    --without-compress-install \
    --without-native-compilation \
    --without-selinux \
    --without-gpm \
    --without-lcms2 \
    --with-modules \
    --with-threads \
    --with-zlib \
    --with-xml2=yes \
    --with-gnutls=yes \
    --with-tree-sitter=yes \
    --with-pdumper=yes \
    --with-dumping=pdumper \
    --with-file-notification=inotify \
    CFLAGS="-O2 -std=gnu17 -I${_static_prefix}/include -I${_static_prefix}/include/ncursesw" \
    LDFLAGS="-static -no-pie -L${_static_prefix}/lib -Wl,--allow-multiple-definition" \
    CPPFLAGS="-I${_static_prefix}/include -I${_static_prefix}/include/ncursesw" \
    LIBXML2_CFLAGS="-I${_static_prefix}/include/libxml2" \
    LIBXML2_LIBS="-L${_static_prefix}/lib -lxml2 -lz -lm" \
    LIBGNUTLS_CFLAGS="-I${_static_prefix}/include" \
    LIBGNUTLS_LIBS="-L${_static_prefix}/lib -lgnutls -lhogweed -lnettle -lgmp" \
    TREE_SITTER_CFLAGS="-I${_static_prefix}/include" \
    TREE_SITTER_LIBS="-L${_static_prefix}/lib -ltree-sitter"

  make -j$(nproc)
}

check() {
  cd "emacs-${pkgver}"
  local binary="src/emacs"

  echo "=== Static linkage verification ==="
  file "$binary"
  ldd "$binary" 2>&1 | grep -q "not a dynamic executable" || { echo "FAIL: not static"; return 1; }
  readelf -d "$binary" 2>/dev/null | grep -q NEEDED && { echo "FAIL: has NEEDED entries"; return 1; }
  readelf -l "$binary" 2>/dev/null | grep -q INTERP && { echo "FAIL: has INTERP"; return 1; }

  echo "=== Feature verification ==="
  ./src/emacs --version
  ./src/emacs --batch --eval '(message "%s" system-configuration-features)' 2>&1
  ./src/emacs --batch --eval '(message "GnuTLS: %s" (gnutls-available-p))' 2>&1
  ./src/emacs --batch --eval '(message "tree-sitter: %s" (treesit-available-p))' 2>&1

  echo "=== PID1 patch verification ==="
  # pid1-mode is nil without --pid1
  ./src/emacs --batch --eval '(unless (eq pid1-mode nil) (kill-emacs 1))' 2>&1
  echo "PASS: pid1-mode is nil without --pid1"
  # pid1-mode is t with --pid1
  ./src/emacs --pid1 --batch --eval '(unless (eq pid1-mode t) (kill-emacs 1))' 2>&1
  echo "PASS: pid1-mode is t with --pid1"
  # --help shows --pid1
  ./src/emacs --help 2>&1 | grep -q "\-\-pid1" || { echo "FAIL: --help missing --pid1"; return 1; }
  echo "PASS: --help shows --pid1"
  # Hooks are defined
  ./src/emacs --pid1 --batch --eval \
    '(unless (and (boundp (quote pid1-boot-hook))
                  (boundp (quote pid1-poweroff-hook))
                  (boundp (quote pid1-reboot-hook)))
       (kill-emacs 1))' 2>&1
  echo "PASS: PID1 hooks are defined"

  echo "=== Neutral startup verification ==="
  # Confirm no implicit el-init load in PID1 mode.
  # This catches regressions that reintroduce autostart wiring.
  ./src/emacs --pid1 --batch \
    --eval '(when (featurep (quote elinit)) (kill-emacs 1))' 2>&1
  echo "PASS: elinit is not loaded implicitly with --pid1"

  echo "PASS: All checks passed"
}

package() {
  cd "emacs-${pkgver}"
  make DESTDIR="${pkgdir}" install

  # Remove conflict with ctags package
  mv "${pkgdir}"/usr/bin/{ctags,ctags.emacs}
  if [ -f "${pkgdir}/usr/share/man/man1/ctags.1.gz" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1.gz,ctags.emacs.1.gz}
  elif [ -f "${pkgdir}/usr/share/man/man1/ctags.1" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1,ctags.emacs.1}
  fi

  # ── Neutral packaging verification ──
  # Confirm no autostart wiring or elinit payload exists in the package.
  echo "=== Neutral packaging verification ==="
  local _site_lisp="${pkgdir}/usr/share/emacs/site-lisp"
  if [ -f "${_site_lisp}/site-start.el" ]; then
    echo "FAIL: site-start.el found in package (implicit autoload risk)"
    return 1
  fi
  echo "PASS: no site-start.el in package"
  if [ -d "${_site_lisp}/elinit" ]; then
    echo "FAIL: elinit/ directory found in package (bundled payload)"
    return 1
  fi
  echo "PASS: no elinit/ directory in package"
}
