# Maintainer: Static Emacs Project
# Full-featured static emacs-nox with PID1 patches and baked-in elinit
#
# The six original variants (minimal, full, nativecomp x Arch/Nix) are
# untouched legacy variants; this file is an additive new variant.
#
# This variant extends PKGBUILD-static-nox with:
#   1. PID1 Emacs patches (--pid1 flag, signal handling, child reaping, hooks)
#   2. Bundled elinit (service manager) in site-lisp
#   3. Prebuilt C helpers (elinit-logd, elinit-runas, elinit-rlimits)
#   4. Autostart bootstrap: elinit hooks into pid1-boot-hook when --pid1 is used
#
# The -patched-for-pid1 suffix is a CAPABILITY marker: the binary supports
# --pid1 mode but does NOT activate it unless --pid1 is explicitly passed.
# Normal Emacs usage (without --pid1) is completely unchanged.
#
# Disable gate: set EMACS_ELINIT_DISABLE=1 to suppress autostart even
# with --pid1. Or set elinit-pid1-autostart-disabled to t in early-init.el.
#
# Feature set (same as PKGBUILD-static-nox):
#   GMP, GnuTLS, libxml2, tree-sitter, modules, threads, zlib, pdumper,
#   inotify, ncurses
# Additional PID1 features:
#   --pid1 flag, pid1-mode variable, pid1-boot-hook, pid1-poweroff-hook,
#   pid1-reboot-hook, automatic child reaping, signal handling
#   (SIGTERM/SIGUSR1→poweroff, SIGINT/SIGUSR2→reboot, SIGHUP→ignored)

pkgname=emacs-nox-static-elinit-patched-for-pid1
pkgver=30.2
pkgrel=1
pkgdesc='GNU Emacs (nox) — static, full-featured, PID1 patched, with elinit'
arch=('x86_64')
url='https://www.gnu.org/software/emacs/emacs.html'
license=('GPL3')
depends=()  # none — it's static
optdepends=(
  'tree-sitter-grammars: tree-sitter language grammars'
)
makedepends=(
  gcc
  make
  autoconf
  automake
  texinfo
  glibc
  zlib
)
provides=(emacs)
conflicts=(emacs)
source=(
  "https://ftp.gnu.org/gnu/emacs/emacs-${pkgver}.tar.xz"
  "https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.5.tar.gz"
  "https://ftp.gnu.org/pub/gnu/gmp/gmp-6.3.0.tar.xz"
  "https://ftp.gnu.org/pub/gnu/nettle/nettle-3.10.1.tar.gz"
  "https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.9.tar.xz"
  "https://download.gnome.org/sources/libxml2/2.15/libxml2-2.15.1.tar.xz"
  "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.25.6.tar.gz"
)
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

# ── Location of elinit repo (relative to PKGBUILD) ──
_elinit_root="${startdir}/.."

prepare() {
  _static_prefix="${srcdir}/static-libs"

  # ── Apply PID1 patches to Emacs source ──
  cd "${srcdir}/emacs-${pkgver}"
  for _patch in "${startdir}/patches/emacs-"*.patch; do
    msg2 "Applying $(basename "$_patch")..."
    patch -Np1 < "$_patch"
  done

  # ── Build static ncurses (wide-char) ──
  cd "${srcdir}/ncurses-6.5"
  ./configure --prefix="${_static_prefix}" \
    --with-normal --without-shared --without-debug \
    --without-cxx --without-cxx-binding --enable-widec \
    --without-ada --without-manpages --without-tests
  make -j$(nproc)
  make install
  cd "${_static_prefix}/lib"
  ln -sf libncursesw.a libncurses.a
  ln -sf libncursesw.a libtinfo.a
  ln -sf libncursesw.a libtinfow.a

  # ── Build static GMP ──
  cd "${srcdir}/gmp-6.3.0"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared CC="gcc -std=gnu17"
  make -j$(nproc)
  make install
  rm -f "${_static_prefix}/include/config.h"

  # ── Build static nettle ──
  cd "${srcdir}/nettle-3.10.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-documentation --disable-openssl \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static GnuTLS ──
  cd "${srcdir}/gnutls-3.8.9"
  PKG_CONFIG_PATH="${_static_prefix}/lib/pkgconfig" \
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --disable-cxx --disable-tools --disable-doc \
    --disable-libdane --disable-guile --disable-nls \
    --without-p11-kit --without-idn --without-brotli --without-zstd \
    --without-tpm --with-tpm2=no \
    --with-included-unistring --with-included-libtasn1 \
    --disable-hardware-acceleration \
    CFLAGS="-O2" \
    LDFLAGS="-L${_static_prefix}/lib" \
    CPPFLAGS="-I${_static_prefix}/include" \
    GMP_LIBS="-L${_static_prefix}/lib -lgmp" \
    GMP_CFLAGS="-I${_static_prefix}/include" \
    NETTLE_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    NETTLE_CFLAGS="-I${_static_prefix}/include" \
    HOGWEED_LIBS="-L${_static_prefix}/lib -lhogweed -lnettle -lgmp" \
    HOGWEED_CFLAGS="-I${_static_prefix}/include"
  make -j$(nproc)
  make install

  # ── Build static libxml2 ──
  cd "${srcdir}/libxml2-2.15.1"
  ./configure --prefix="${_static_prefix}" \
    --enable-static --disable-shared \
    --without-python --without-icu --without-lzma \
    --without-readline --without-http \
    CFLAGS="-O2"
  make -j$(nproc)
  make install

  # ── Build static tree-sitter ──
  cd "${srcdir}/tree-sitter-0.25.6"
  make PREFIX="${_static_prefix}" -j$(nproc)
  make PREFIX="${_static_prefix}" install

  rm -f "${_static_prefix}/include/config.h"
}

build() {
  _static_prefix="${srcdir}/static-libs"
  cd "emacs-${pkgver}"

  PKG_CONFIG=false ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --libexecdir=/usr/lib \
    --localstatedir=/var \
    --without-all \
    --without-x \
    --without-sound \
    --without-dbus \
    --without-libsystemd \
    --without-compress-install \
    --without-native-compilation \
    --without-selinux \
    --without-gpm \
    --without-lcms2 \
    --with-modules \
    --with-threads \
    --with-zlib \
    --with-xml2=yes \
    --with-gnutls=yes \
    --with-tree-sitter=yes \
    --with-pdumper=yes \
    --with-dumping=pdumper \
    --with-file-notification=inotify \
    CFLAGS="-O2 -std=gnu17 -I${_static_prefix}/include -I${_static_prefix}/include/ncursesw" \
    LDFLAGS="-static -no-pie -L${_static_prefix}/lib -Wl,--allow-multiple-definition" \
    CPPFLAGS="-I${_static_prefix}/include -I${_static_prefix}/include/ncursesw" \
    LIBXML2_CFLAGS="-I${_static_prefix}/include/libxml2" \
    LIBXML2_LIBS="-L${_static_prefix}/lib -lxml2 -lz -lm" \
    LIBGNUTLS_CFLAGS="-I${_static_prefix}/include" \
    LIBGNUTLS_LIBS="-L${_static_prefix}/lib -lgnutls -lhogweed -lnettle -lgmp" \
    TREE_SITTER_CFLAGS="-I${_static_prefix}/include" \
    TREE_SITTER_LIBS="-L${_static_prefix}/lib -ltree-sitter"

  make -j$(nproc)

  # ── Build elinit C helpers ──
  msg2 "Building elinit C helpers..."
  make -C "${_elinit_root}/libexec" clean
  make -C "${_elinit_root}/libexec" all \
    CC="gcc" CFLAGS="-Wall -Wextra -Werror -pedantic -std=c99 -O2"
}

check() {
  cd "emacs-${pkgver}"
  local binary="src/emacs"

  echo "=== Static linkage verification ==="
  file "$binary"
  ldd "$binary" 2>&1 | grep -q "not a dynamic executable" || { echo "FAIL: not static"; return 1; }
  readelf -d "$binary" 2>/dev/null | grep -q NEEDED && { echo "FAIL: has NEEDED entries"; return 1; }
  readelf -l "$binary" 2>/dev/null | grep -q INTERP && { echo "FAIL: has INTERP"; return 1; }

  echo "=== Feature verification ==="
  ./src/emacs --version
  ./src/emacs --batch --eval '(message "%s" system-configuration-features)' 2>&1
  ./src/emacs --batch --eval '(message "GnuTLS: %s" (gnutls-available-p))' 2>&1
  ./src/emacs --batch --eval '(message "tree-sitter: %s" (treesit-available-p))' 2>&1

  echo "=== PID1 patch verification ==="
  # pid1-mode is nil without --pid1
  ./src/emacs --batch --eval '(unless (eq pid1-mode nil) (kill-emacs 1))' 2>&1
  echo "PASS: pid1-mode is nil without --pid1"
  # pid1-mode is t with --pid1
  ./src/emacs --pid1 --batch --eval '(unless (eq pid1-mode t) (kill-emacs 1))' 2>&1
  echo "PASS: pid1-mode is t with --pid1"
  # --help shows --pid1
  ./src/emacs --help 2>&1 | grep -q "\-\-pid1" || { echo "FAIL: --help missing --pid1"; return 1; }
  echo "PASS: --help shows --pid1"
  # Hooks are defined
  ./src/emacs --pid1 --batch --eval \
    '(unless (and (boundp (quote pid1-boot-hook))
                  (boundp (quote pid1-poweroff-hook))
                  (boundp (quote pid1-reboot-hook)))
       (kill-emacs 1))' 2>&1
  echo "PASS: PID1 hooks are defined"

  echo "PASS: All checks passed (A3 package-payload checks run in package phase)"
}

package() {
  cd "emacs-${pkgver}"
  make DESTDIR="${pkgdir}" install

  # Remove conflict with ctags package
  mv "${pkgdir}"/usr/bin/{ctags,ctags.emacs}
  if [ -f "${pkgdir}/usr/share/man/man1/ctags.1.gz" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1.gz,ctags.emacs.1.gz}
  elif [ -f "${pkgdir}/usr/share/man/man1/ctags.1" ]; then
    mv "${pkgdir}"/usr/share/man/man1/{ctags.1,ctags.emacs.1}
  fi

  # ── Install elinit runtime files ──
  local _sup_dest="${pkgdir}/usr/share/emacs/site-lisp/elinit"
  install -d "${_sup_dest}"
  install -m 644 "${_elinit_root}"/elinit.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-core.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-log.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-overrides.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-sandbox.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-libexec.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-units.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-timer.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-dashboard.el "${_sup_dest}/"
  install -m 644 "${_elinit_root}"/elinit-cli.el "${_sup_dest}/"

  # ── Install prebuilt C helper binaries ──
  local _libexec_dest="${_sup_dest}/libexec"
  install -d "${_libexec_dest}"
  install -m 755 "${_elinit_root}"/libexec/elinit-logd "${_libexec_dest}/"
  install -m 755 "${_elinit_root}"/libexec/elinit-runas "${_libexec_dest}/"
  install -m 755 "${_elinit_root}"/libexec/elinit-rlimits "${_libexec_dest}/"

  # ── Install autostart bootstrap ──
  # This file is loaded by Emacs during startup via site-lisp.
  # It wires elinit into PID1 mode autostart.
  cat > "${pkgdir}/usr/share/emacs/site-lisp/site-start.el" <<'SITE_START_EOF'
;;; site-start.el --- Elinit PID1 autostart bootstrap  -*- lexical-binding: t -*-

;; Installed by emacs-nox-static-elinit-patched-for-pid1.
;; This file auto-loads elinit when Emacs is started with --pid1.

;; Always add elinit to load-path (available for manual use too)
(add-to-list 'load-path "/usr/share/emacs/site-lisp/elinit")

;; Autostart elinit in PID1 mode (unless explicitly disabled)
(when (and (bound-and-true-p pid1-mode)
           (not (getenv "EMACS_ELINIT_DISABLE"))
           (not (bound-and-true-p elinit-pid1-autostart-disabled)))
  (require 'elinit)
  ;; Helpers are prebuilt — never attempt to compile on startup
  (setq elinit-libexec-build-on-startup 'never)
  (add-hook 'pid1-boot-hook #'elinit-start))

;;; site-start.el ends here
SITE_START_EOF

  # ── Install sbin scripts ──
  local _sbin_dest="${pkgdir}/usr/bin"
  for script in elinitctl elinit-import elinit-log-prune elinit-logrotate; do
    if [ -f "${_elinit_root}/sbin/${script}" ]; then
      install -m 755 "${_elinit_root}/sbin/${script}" "${_sbin_dest}/"
    fi
  done

  # ── A2/A3 package-payload verification ──
  # All checks run against packaged paths, not source tree.
  local _site_lisp="${pkgdir}/usr/share/emacs/site-lisp"

  echo "=== A3 elinit load-path verification (packaged layout) ==="
  ./src/emacs --batch \
    --eval "(add-to-list 'load-path \"${_sup_dest}\")" \
    --eval '(require (quote elinit))' \
    --eval '(unless (featurep (quote elinit)) (kill-emacs 1))' 2>&1
  echo "PASS: elinit loads from packaged site-lisp path"

  echo "=== A3 C helper binary verification (packaged payload) ==="
  for helper in elinit-logd elinit-runas elinit-rlimits; do
    test -x "${_sup_dest}/libexec/${helper}" || { echo "FAIL: ${helper} not executable in package"; return 1; }
    echo "PASS: ${helper} is executable in package payload"
  done

  echo "=== A2/A3 autostart verification ==="
  # A2 acceptance #1 / A3 acceptance #3: --pid1 bootstrap loads elinit and
  # running pid1-boot-hook executes elinit-start without error.
  # After site-start loads, elinit-start is on the hook and elinit is required.
  # run-hooks proves the full chain: hook -> elinit-start -> no error.
  ./src/emacs --pid1 --batch \
    --eval "(add-to-list 'load-path \"${_sup_dest}\")" \
    --eval "(load \"${_site_lisp}/site-start\" nil t)" \
    --eval '(unless (featurep (quote elinit)) (kill-emacs 1))' \
    --eval '(run-hooks (quote pid1-boot-hook))' 2>&1
  echo "PASS: pid1-boot-hook executes elinit-start successfully"
  # Verify no-rebuild setting
  ./src/emacs --pid1 --batch \
    --eval "(add-to-list 'load-path \"${_sup_dest}\")" \
    --eval "(load \"${_site_lisp}/site-start\" nil t)" \
    --eval '(unless (eq elinit-libexec-build-on-startup (quote never)) (kill-emacs 1))' 2>&1
  echo "PASS: elinit-libexec-build-on-startup is never (no startup rebuild)"
  # A2 acceptance #2: without --pid1, elinit does not autostart
  ./src/emacs --batch \
    --eval "(add-to-list 'load-path \"${_sup_dest}\")" \
    --eval "(load \"${_site_lisp}/site-start\" nil t)" \
    --eval '(when (featurep (quote elinit)) (kill-emacs 1))' 2>&1
  echo "PASS: no autostart without --pid1"
  # A2 acceptance #3: EMACS_ELINIT_DISABLE env var gate
  EMACS_ELINIT_DISABLE=1 ./src/emacs --pid1 --batch \
    --eval "(add-to-list 'load-path \"${_sup_dest}\")" \
    --eval "(load \"${_site_lisp}/site-start\" nil t)" \
    --eval '(when (featurep (quote elinit)) (kill-emacs 1))' 2>&1
  echo "PASS: EMACS_ELINIT_DISABLE=1 prevents autostart"
  # A2 acceptance #4: elinit-pid1-autostart-disabled Lisp gate
  # Simulates early-init load order: variable set before site-start runs.
  # (--batch does not load early-init.el, so we use -l to replicate ordering.)
  local _gate_tmpdir
  _gate_tmpdir=$(mktemp -d)
  printf '(setq elinit-pid1-autostart-disabled t)\n' > "${_gate_tmpdir}/gate.el"
  ./src/emacs --pid1 --batch \
    -l "${_gate_tmpdir}/gate.el" \
    --eval "(add-to-list 'load-path \"${_sup_dest}\")" \
    --eval "(load \"${_site_lisp}/site-start\" nil t)" \
    --eval '(when (featurep (quote elinit)) (kill-emacs 1))' 2>&1
  rm -rf "${_gate_tmpdir}"
  echo "PASS: elinit-pid1-autostart-disabled prevents autostart"
  echo "PASS: All A2/A3 checks passed"
}
