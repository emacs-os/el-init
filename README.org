[[https://github.com/cypherpunk2001/supervisor.el/actions/workflows/ci.yml][https://github.com/cypherpunk2001/supervisor.el/actions/workflows/ci.yml/badge.svg]]

* supervisor.el Handbook

*A process supervisor for Emacs.*

~supervisor.el~ aims to be robust enough to serve as PID 2, but not
init. In practice, it is best suited for userland: managing desktop sessions
under window managers like EXWM, or running inside
long-lived daemonized Emacs instances that need to manage child processes or
automate tasks with timers.

Define your services in Elisp, organize them into startup stages, declare
dependencies between them, and let supervisor handle the rest. When something
crashes, it restarts. When you log out, everything stops cleanly.

** Features

- *Staged startup*: Services start in four stages (stage1 through stage4), so
  your X session setup runs before your system tray, and your tray runs before
  the applets that need it.

- *Dependencies*: Say "start polkit before nm-applet" with ~:after~, or "only
  start this if that exists" with ~:requires~.

- *Two service types*: Long-running daemons (~simple~) that restart on crash,
  and run-once scripts (~oneshot~) for initialization commands.

- *Crash recovery*: Simple services automatically restart when they die.
  Crash-looping services are marked failed after repeated crashes.

- *Interactive dashboard*: ~M-x supervisor~ opens a live view where you can
  start, stop, restart, enable, and disable services with single keystrokes.

- *CLI control*: The included ~sbin/supervisorctl~ script lets you manage
  services from any terminal, even remotely via SSH.

- *Scheduled tasks*: An experimental timer subsystem can run oneshots on cron-like
  schedules.

** Requirements

- Emacs 28.1 or later
- Optional: ~transient~ package for the dashboard help menu (~?~ key)
- For CLI: ~emacsclient~, ~base64~, and ~sed~ in your ~PATH~

** Handbook Overview

This document is the complete reference. Run ~M-x supervisor-handbook~ to open
it in Emacs at any time.

The [[#quick-start][Quick Start]] below gets you running immediately. The rest of the handbook
provides detailed reference material:

- [[#service-definition-handbook-supervisor-programs][Service Definition Handbook]] - all the options for defining services
- [[#startup-and-lifecycle-model][Startup and Lifecycle Model]] - how stages, dependencies, and restarts work
- [[#runtime-overrides-and-reconciliation][Runtime Overrides]] - enabling, disabling, and policy changes at runtime
- [[#timer-subsystem-handbook-experimental][Timer Subsystem]] - scheduled oneshot execution (experimental)
- [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook]] - the interactive UI
- [[#cli-handbook-sbinsupervisorctl][CLI Handbook]] - terminal control with ~supervisorctl~
- [[#events-and-hooks][Events and Hooks]] - programmatic integration
- [[#customization-reference][Customization Reference]] - all variables and faces
- [[#command-reference][Command Reference]] - every interactive command

* Quick Start
:PROPERTIES:
:CUSTOM_ID: quick-start
:END:

#+begin_src emacs-lisp
(add-to-list 'load-path "~/repos/supervisor.el")
(require 'supervisor)

;; Event hook for failures only - stage messages are handled by core
(add-hook 'supervisor-event-hook
          (lambda (event)
            (pcase (plist-get event :type)
              ('process-failed
               (message "Supervisor: FAILED to start %s" (plist-get event :id)))
              ('process-exit
               (let ((code (plist-get (plist-get event :data) :code)))
                 (unless (eq code 0)
                   (message "Supervisor: %s exited with code %s"
                            (plist-get event :id) code)))))))

(setq supervisor-programs
      `(;; Stage 1: X session setup (oneshots)
        ;; Use backtick+comma for Elisp expansion instead of sh -c for shell expansion
        (,(format "xhost +SI:localuser:%s" (user-login-name))
         :type oneshot :id "xhost" :stage stage1 :tags (x-setup))
        (,(format "xrdb -merge %s" (expand-file-name "~/.Xresources"))
         :type oneshot :id "xrdb" :stage stage1 :after "xhost" :tags (x-setup))
        ("xsetroot -cursor_name left_ptr" :type oneshot :id "xsetroot" :stage stage1
         :tags (x-setup))
        ("xset r rate 200 60" :type oneshot :id "xset-repeat" :stage stage1
         :tags (x-setup))
        ("xset -dpms" :type oneshot :id "xset-dpms" :stage stage1
         :tags (x-setup))
        ("xset s off" :type oneshot :id "xset-s" :stage stage1
         :tags (x-setup))
        ("xinput set-prop \"Kingsis Peripherals ZOWIE Gaming mouse\" \"libinput Accel Profile Enabled\" 0 1"
         :type oneshot :id "xinput-mouse" :stage stage1 :tags (x-setup))
        ("redshift -P -O 2500"
         :type oneshot :id "redshift" :stage stage1 :tags (x-setup))

        ;; Stage 2: system agents
        ("/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1"
         :type simple :id "polkit" :stage stage2 :restart t :tags (system))

        ;; Stage 3: tray applets (delay for EXWM systray init)
        ("nm-applet" :type simple :stage stage3 :delay 3 :restart t :tags (applet tray))

        ;; Stage 4: more tray applets
        ("blueman-applet" :type simple :stage stage4 :delay 3 :restart t :tags (applet tray))
        ("pasystray" :type simple :stage stage4 :delay 3 :restart t :tags (applet tray))))

;; Use supervisor-stop-now for immediate SIGKILL - ensures clean X session exit
(add-hook 'kill-emacs-hook #'supervisor-stop-now)

;; Don't ask about running processes on exit - supervisor handles cleanup
(setq confirm-kill-processes nil)

;; Start supervisor
(supervisor-start)
#+end_src

Suggested hooks when Emacs is your session owner:

#+begin_src emacs-lisp
(add-hook 'after-init-hook #'supervisor-start)
;; Alternative for some init flows:
;; (add-hook 'emacs-startup-hook #'supervisor-start)
;; Example package-manager-specific hook:
;; (add-hook 'elpaca-after-init-hook #'supervisor-start)
(add-hook 'kill-emacs-hook #'supervisor-stop-now)
#+end_src

Once running, ~sbin/supervisorctl status~ shows the current state:

#+begin_example
$ sbin/supervisorctl status
ID               TYPE     STAGE    ENABLED  STATUS     RESTART  LOG   PID     REASON
----------------------------------------------------------------------------------------------------
xhost            oneshot  stage1   yes      done       n/a      yes   -       -
xrdb             oneshot  stage1   yes      done       n/a      yes   -       -
xsetroot         oneshot  stage1   yes      done       n/a      yes   -       -
xset-repeat      oneshot  stage1   yes      done       n/a      yes   -       -
xset-dpms        oneshot  stage1   yes      done       n/a      yes   -       -
xset-s           oneshot  stage1   yes      done       n/a      yes   -       -
xinput-mouse     oneshot  stage1   yes      done       n/a      yes   -       -
redshift         oneshot  stage1   yes      done       n/a      yes   -       -
polkit           simple   stage2   yes      running    yes      yes   1280    -
nm-applet        simple   stage3   yes      running    yes      yes   1396    -
blueman-applet   simple   stage4   yes      running    yes      yes   1927    -
pasystray        simple   stage4   yes      running    yes      yes   1442    -
#+end_example

Enable the experimental timer subsystem only if you are using timers:

#+begin_src emacs-lisp
;; Parent mode must also be on.
(supervisor-mode 1)
(supervisor-timer-subsystem-mode 1)
#+end_src

* Service Definition Handbook (~supervisor-programs~)
:PROPERTIES:
:CUSTOM_ID: service-definition-handbook-supervisor-programs
:END:

~supervisor-programs~ is a list of entries.

Entry forms:

- Command string: ~"nm-applet"~
- Command + plist: ~("nm-applet" :id "nm" :stage stage3 ...)~

** Entry Keywords

| Keyword | Type | Default | Notes |
| ~:id~ | string | basename of executable token | Must be string if provided |
| ~:type~ | symbol | ~simple~ | ~simple~ or ~oneshot~ |
| ~:stage~ | symbol | ~stage3~ | ~stage1~, ~stage2~, ~stage3~, ~stage4~ |
| ~:delay~ | non-negative number | ~0~ | Delays spawn in seconds |
| ~:after~ | string or list of strings | ~nil~ | Ordering dependency (same stage) |
| ~:requires~ | string or list of strings | ~nil~ | Requirement + ordering dependency (same stage) |
| ~:enabled~ | boolean | ~t~ | Enable/disable service |
| ~:disabled~ | boolean | ~nil~ | Inverse form of ~:enabled~ |
| ~:restart~ | boolean | ~t~ | For ~simple~ only |
| ~:no-restart~ | boolean | ~nil~ | Inverse form of ~:restart~ |
| ~:logging~ | boolean | ~t~ | Per-process log capture |
| ~:oneshot-wait~ | boolean | ~supervisor-oneshot-default-wait~ | For ~oneshot~ only |
| ~:async~ | boolean | ~nil~ | Alias for non-blocking oneshot (~not :oneshot-wait~) |
| ~:oneshot-timeout~ | number or ~nil~ | ~supervisor-oneshot-timeout~ | For ~oneshot~ only |
| ~:tags~ | symbol, string, or list | ~nil~ | Dashboard tag filtering |

** Validation Rules

Validation is performed by ~supervisor--validate-entry~ and plan building.

- Unknown keywords are rejected.
- ~:id~ must be a string when present.
- ~:type~ must be symbol ~simple~ or ~oneshot~.
- ~:stage~ must be symbol ~stage1..stage4~.
- ~:delay~ must be non-negative number.
- ~:oneshot-timeout~ must be number or ~nil~.
- ~:after~ and ~:requires~ must be string or proper list of strings.
- Mutually exclusive pairs are rejected: ~:enabled~ with ~:disabled~, ~:restart~
  with ~:no-restart~, and ~:oneshot-wait~ with ~:async~.
- Type restrictions are enforced: ~oneshot~ rejects ~:restart~ and
  ~:no-restart~; ~simple~ rejects ~:oneshot-wait~, ~:async~, and
  ~:oneshot-timeout~.

Invalid entries are skipped at start/reload and shown as ~invalid~ in dashboard
and CLI status/validate output.

** ID Resolution and Duplicate Handling

ID resolution for string entries uses the basename of the first command token
(after ~split-string-and-unquote~).

Duplicate IDs are deterministic:

- First valid occurrence wins.
- Later duplicates are skipped with warning.

** Dependency Semantics: ~:after~ vs ~:requires~

- ~:after~: ordering only.
- ~:requires~: pull-in + ordering.

Planner rules:

- Both are constrained to same-stage dependencies.
- Cross-stage ~:after~ is ignored with warning.
- Cross-stage ~:requires~ is an error (entry invalid).
- Missing dependencies are ignored with warning.
- Topological sort uses stable list order as tie-break.
- Cycle fallback clears dependency edges for affected stage and falls back to
  deterministic list order.

** Internal Normalized Shape

Valid entries are normalized to schema v1 tuple form:

#+begin_src elisp
(id cmd delay enabled-p restart-p logging-p type stage after
    oneshot-wait oneshot-timeout tags requires)
#+end_src

Accessor functions (~supervisor-entry-id~, ~supervisor-entry-command~, etc.) are
the canonical way to read entry fields.

** Validation and Dry-Run Commands

~M-x supervisor-validate~:

- validates services
- validates timers when timer module is available
- populates invalid hashes for dashboard/CLI visibility
- opens ~*supervisor-validate*~ report buffer

~M-x supervisor-dry-run~:

- builds plan without starting processes
- prints stage order and resolved dependency metadata
- prints timer validation summary when timers are configured
- opens ~*supervisor-dry-run*~ report buffer

* Startup and Lifecycle Model
:PROPERTIES:
:CUSTOM_ID: startup-and-lifecycle-model
:END:

** Stages and Ordering

Stage order is fixed:

- ~stage1~
- ~stage2~
- ~stage3~
- ~stage4~

Stages execute sequentially; entries inside a stage execute in dependency order,
with parallelism allowed where dependencies permit.

** Async DAG Scheduler Semantics

Within a stage:

- In-degree 0 entries are eligible to start.
- Dependents unlock when prerequisites become ready.
- Disabled entries are marked ready immediately.
- Start failures mark ready immediately (do not block graph).
- Optional ~supervisor-max-concurrent-starts~ limits active spawn attempts.

Ready semantics:

- ~simple~: ready when process spawns.
- ~oneshot~: ready on exit (success/failure) or timeout.

Stage completion requires all of:

- all entries started/skipped/failed-to-spawn,
- no pending delay timers,
- no pending blocking oneshots.

** Lifecycle State Machine

Per-entry runtime state is tracked in ~supervisor--entry-state~.

States:

- ~stage-not-started~
- ~waiting-on-deps~
- ~delayed~
- ~disabled~
- ~started~
- ~failed-to-spawn~
- ~stage-timeout~

~invalid~ is a surfaced status (from validation hash tables), not a lifecycle FSM
state in ~supervisor--entry-state~.

Invalid transitions signal errors unless forced by internal maintenance paths.

** Process Spawn and Command Execution

Processes are created via ~make-process~.

- Command arguments are parsed by ~split-string-and-unquote~.
- No implicit shell is used.
- Use explicit shell (~sh -c ...~) when shell semantics are required (for
  example pipelines ~cmd1 | cmd2~, redirects ~> file~, or shell expansion like
  ~$HOME~).

** Restart and Crash Loop Policy (~simple~)

Restart behavior is controlled by effective restart policy
(config + runtime override).

- Delay: ~supervisor-restart-delay~
- Window: ~supervisor-restart-window~ seconds
- Threshold: ~supervisor-max-restarts~
- On crash-loop threshold, service is marked failed (~dead~) and restart stops.

~oneshot~ services are not auto-restarted.

** Oneshot Exit Encoding

For oneshot completion tracking (~supervisor--oneshot-completed~):

- normal exit stores exit code (~0~, ~1~, ...)
- signal death stores negative signal number (~SIGKILL~ -> ~-9~)

This is used by status/reporting and timer retry eligibility.

** Stop Semantics

~supervisor-stop~ (async graceful):

- sends ~SIGTERM~
- waits asynchronously for exits
- after ~supervisor-shutdown-timeout~, sends ~SIGKILL~ to survivors

~supervisor-stop-now~ (sync hard stop):

- sends immediate ~SIGKILL~
- waits up to ~0.5s~ for process death
- intended for ~kill-emacs-hook~

* Runtime Overrides and Reconciliation
:PROPERTIES:
:CUSTOM_ID: runtime-overrides-and-reconciliation
:END:

** Runtime Overrides

Three override tables are supported:

- enabled override (~supervisor--enabled-override~)
- restart override (~supervisor--restart-override~)
- logging override (~supervisor--logging~)

Effective value resolution is:

- explicit runtime override if present,
- otherwise config default.

** Persistence of Overrides

Overrides are persisted in ~supervisor-overrides-file~.

- Saved with atomic write (temp file + rename)
- Loaded on ~supervisor-start~
- Corrupt file is logged and preserved

Interactive helpers:

- ~M-x supervisor-overrides-load~
- ~M-x supervisor-overrides-save~
- ~M-x supervisor-overrides-clear~

Dashboard toggles for enabled/restart persist immediately.
Dashboard logging toggle updates runtime state; use explicit save command (or CLI
logging command) when you want persistence written immediately. In other words:
dashboard logging toggle does not auto-save, but CLI ~logging on|off ...~ does.

** Reload Reconciler (~supervisor-reload~)

Reconcile flow:

1. Build plan
2. Build runtime snapshot
3. Compute actions (~start~, ~stop~, ~noop~, ~skip~)
4. Apply actions

Effects:

- Stops removed entries
- Stops entries now effectively disabled
- Starts newly eligible entries
- Leaves converged entries running

* Timer Subsystem Handbook (Experimental)
:PROPERTIES:
:CUSTOM_ID: timer-subsystem-handbook-experimental
:END:

Timer subsystem lives in ~supervisor-timer.el~ and is disabled by default.

** Gating Contract

Timer subsystem is active only when both are true:

- ~supervisor-mode~ is enabled
- ~supervisor-timer-subsystem-mode~ is enabled

If gate is inactive, timer scheduler side effects do not run.

** Timer Configuration (~supervisor-timers~)

Each timer is a plist.

Required keys:

- ~:id~ (non-empty string)
- ~:target~ (non-empty string; must resolve to a ~oneshot~ service)

Trigger keys (at least one required):

- ~:on-calendar~
- ~:on-startup-sec~
- ~:on-unit-active-sec~

Optional keys:

- ~:enabled~ (boolean, default ~t~)
- ~:persistent~ (boolean, default ~t~)

#+begin_src emacs-lisp
(setq supervisor-timers
      '((:id "daily-backup"
         :target "backup-oneshot"
         :on-calendar (:hour 3 :minute 0)
         :persistent t)
        (:id "warm-cache"
         :target "cache-prime"
         :on-startup-sec 45)
        (:id "sync-loop"
         :target "sync-oneshot"
         :on-unit-active-sec 300)))
#+end_src

** Calendar Trigger Format

~:on-calendar~ accepts either:

- single plist, or
- list of plists (earliest next match wins)

Allowed fields:

- ~:minute~ (0..59)
- ~:hour~ (0..23)
- ~:day-of-month~ (1..31)
- ~:month~ (1..12)
- ~:day-of-week~ (0..6)

Field values:

- integer
- non-empty list of integers
- ~*~ wildcard

Semantics:

- next run is computed strictly after current time
- day-by-day search with bounded horizon (28-year coverage for full leap-day +
  weekday combinations)
- DST gaps are handled by validating encoded/decoded wall clock fields

** Trigger Semantics

~:on-startup-sec~:

- positive integer seconds after scheduler startup
- fires once per supervisor session

~:on-unit-active-sec~:

- positive integer seconds after last successful target completion

Combined timers:

- scheduler chooses earliest due trigger among configured trigger types

** Overlap, Disable, and Missing-Target Behavior

When due:

- Disabled timer -> skipped, miss reason ~disabled~
- Active target oneshot -> skipped, miss reason ~overlap~
- Disabled target service -> skipped, miss reason ~disabled-target~
- Missing target entry -> warning, no trigger

Miss metadata is stored in timer state.

** Retry Policy

Configured by ~supervisor-timer-retry-intervals~ (default ~'(30 120 600)~).

- Retryable failures: positive exit codes only
- Non-retryable: signal deaths (negative stored exit codes), nil, and zero
- Retry budget resets on fresh scheduled runs

** Catch-up Policy

Configured by:

- ~:persistent~ per timer (default ~t~)
- ~supervisor-timer-catch-up-limit~ in seconds (default 24h)

On scheduler start, persistent timers may trigger catch-up runs for missed
schedules within the configured window.

** Timer Persistence

Timer runtime state file: ~supervisor-timer-state-file~.

- Atomic writes (temp + rename)
- Schema versioned
- Newer incompatible schema versions are rejected
- Stale timer IDs are pruned when scheduler starts

Persisted keys include:

- ~:last-run-at~
- ~:last-success-at~
- ~:last-failure-at~
- ~:last-exit~
- ~:last-missed-at~
- ~:last-miss-reason~

Transient keys (for example ~:next-run-at~, retry bookkeeping, startup-consumed
state) are recomputed each session.

** Timer Scheduler Lifecycle

- Started after all service stages complete
- Stopped on ~supervisor-stop~, ~supervisor-stop-now~, and when timer mode is disabled
- Uses ~run-at-time~ scheduling (no polling loop)

** Timer Visibility Surfaces

Dashboard:

- Timer section is shown only when
- ~supervisor-dashboard-show-timers~ is non-nil
- timer subsystem is active
- no stage filter is active
- there are timer rows or invalid timer definitions

CLI:

- ~supervisorctl timers~ shows timer runtime/invalid definitions
- If subsystem is gated off, command returns explicit disabled status

* Dashboard Handbook (~M-x supervisor~)
:PROPERTIES:
:CUSTOM_ID: dashboard-handbook-m-x-supervisor
:END:

Dashboard buffer: ~*supervisor*~, major mode ~supervisor-dashboard-mode~
(derived from ~tabulated-list-mode~).

** Service Columns

- ~ID~
- ~Type~
- ~Stage~
- ~Enabled~
- ~Status~
- ~Restart~
- ~Log~
- ~PID~
- ~Reason~

** Service Status Values

- ~running~
- ~done~
- ~failed~
- ~dead~
- ~pending~
- ~stopped~
- ~invalid~

~invalid~ here means configuration/validation failure, not a runtime FSM state.

** Service Reason Values

- ~disabled~
- ~delayed~
- ~waiting-on-deps~
- ~stage-not-started~
- ~failed-to-spawn~
- ~stage-timeout~
- ~crash-loop~

** Timer Rows in Dashboard

Timer rows are informational and use timer runtime state.

Timer row status values:

- ~active~ (target currently running)
- ~done~ (last exit ~0~)
- ~failed~ (last exit non-zero)
- ~pending~ (no completion yet)

Timer reason column shows either:

- ~missed: <reason>~, or
- ~next: <relative time>~

** Dashboard Keymap

| Key | Function |
| ~e~ | Toggle enabled override |
| ~f~ | Cycle stage filter |
| ~t~ | Cycle tag filter |
| ~s~ | Start selected service |
| ~k~ | Kill selected service (confirm) |
| ~K~ | Kill selected service (force) |
| ~r~ | Toggle restart override |
| ~l~ | Toggle logging override |
| ~L~ | Open selected service log file |
| ~p~ | Open ~proced~ |
| ~P~ | Toggle proced auto-update |
| ~d~ | Show dependencies for selected service |
| ~D~ | Show full dependency graph |
| ~B~ | Show startup blame timings |
| ~g~ | Refresh dashboard |
| ~G~ | Toggle auto-refresh |
| ~?~ | Open transient action menu |
| ~i~ | Describe row (~C-u i~ shows status legend) |
| ~h~ | Open dashboard help buffer |
| ~q~ | Quit dashboard |

Notes:

- Separator rows reject service actions.
- ~?~ requires the ~transient~ package.
- Full ID is echoed in minibuffer when current row ID exceeds table width.

** Mode Interaction and Buffer-Local State

- ~supervisor-mode~ is the parent global mode; enabling it runs
  ~supervisor-start~, disabling it runs ~supervisor-stop~.
- ~supervisor-timer-subsystem-mode~ is an experimental global gate and only
  becomes active when ~supervisor-mode~ is also enabled.
- ~supervisor-dashboard-mode~ is the major mode for ~*supervisor*~ and can be
  opened independently of whether supervision is currently running.
- Dashboard filters are buffer-local:
  ~supervisor--dashboard-stage-filter~ and ~supervisor--dashboard-tag-filter~.
- Dashboard auto-refresh timer (~supervisor--auto-refresh-timer~) is buffer-local
  and defaults to off until toggled with ~G~ / ~M-x supervisor-dashboard-toggle-auto-refresh~.

** Dashboard Faces

All dashboard faces are in customization group ~supervisor~:

| Face | Used for |
| ~supervisor-status-running~ | Status ~running~ |
| ~supervisor-status-done~ | Status ~done~ |
| ~supervisor-status-failed~ | Status ~failed~ |
| ~supervisor-status-dead~ | Status ~dead~ |
| ~supervisor-status-invalid~ | Status ~invalid~ |
| ~supervisor-status-pending~ | Status ~pending~ |
| ~supervisor-status-stopped~ | Status ~stopped~ |
| ~supervisor-type-simple~ | Type ~simple~ |
| ~supervisor-type-oneshot~ | Type ~oneshot~ |
| ~supervisor-type-timer~ | Type ~timer~ rows |
| ~supervisor-stage-1~ | Stage column ~stage1~ |
| ~supervisor-stage-2~ | Stage column ~stage2~ |
| ~supervisor-stage-3~ | Stage column ~stage3~ |
| ~supervisor-stage-4~ | Stage column ~stage4~ |
| ~supervisor-enabled-yes~ | Enabled column (~yes~) |
| ~supervisor-enabled-no~ | Enabled column (~no~) |
| ~supervisor-reason~ | Reason column values |
| ~supervisor-stage-separator~ | Stage separator rows |

* CLI Handbook (~sbin/supervisorctl~)
:PROPERTIES:
:CUSTOM_ID: cli-handbook-sbinsupervisorctl
:END:

The shell wrapper is transport-only; behavior is implemented in
~supervisor-cli.el~ dispatchers.

** Wrapper Syntax

#+begin_src bash
sbin/supervisorctl [WRAPPER-OPTIONS] COMMAND [COMMAND-ARGS]
#+end_src

** Wrapper Options

| Option | Notes |
| ~--help~, ~-h~ | Show wrapper help |
| ~--json~ | Request JSON output from CLI dispatcher |
| ~--socket NAME~, ~--socket-name NAME~, ~-s NAME~ | Use specific local socket |
| ~--server-file PATH~, ~-f PATH~ | Use server file transport |
| ~--timeout N~, ~-t N~ | Pass wait timeout to ~emacsclient -w~ |

Wrapper transport rules:

- ~--socket~ and ~--server-file~ are mutually exclusive.
- ~--server-file~ emits a TCP transport warning.

Wrapper/dispatcher usage behavior:

- Wrapper ~--help~ prints wrapper option help.
- Calling ~supervisorctl~ with no command prints dispatcher usage text and
  command list.

** CLI Commands

Lifecycle:

- ~status [ID...]~
- ~list [ID...]~ (alias of ~status~)
- ~describe ID~
- ~start [-- ID...]~
- ~stop [-- ID...]~
- ~restart [-- ID...]~
- ~reload~
- ~validate~

Overrides and policy:

- ~enable [--] ID...~
- ~disable [--] ID...~
- ~restart-policy (on|off) [--] ID...~
- ~logging (on|off) [--] ID...~

Inspection and utilities:

- ~blame~
- ~graph [ID]~
- ~logs [--tail N] [--] ID~
- ~kill [--signal SIG] [--] ID~
- ~ping~
- ~version~
- ~timers~

Use ~--~ before IDs that start with ~-~ for commands that accept positional
IDs.

** Command Notes

~validate~:

- returns exit code ~4~ if service or timer validation errors exist
- returns both service and timer invalid sets

~start~, ~stop~, ~restart~:

- with IDs: operate on those IDs
- with no IDs: operate on whole supervisor (~start~, ~stop-now~, ~stop-now+start~)

~graph~:

- no ID: full edge list
- with ID: after/requires/blocks for that ID

~timers~:

- explicit disabled response when timer subsystem is gated off

** Output Formats

Human format is default.

~--json~ returns stable object structures per command (for example status,
validate, graph, timers).

Status JSON top-level keys:

- ~entries~ (array)
- ~invalid~ (array)

Timer JSON top-level keys:

- ~timers~ (array)
- ~invalid~ (array)

Validation JSON top-level keys:

- ~services~ with ~valid~, ~invalid~, ~errors~
- ~timers~ with ~valid~, ~invalid~, ~errors~

Error JSON shape (for argument/runtime errors):

- ~error~ (boolean)
- ~message~ (string)
- ~exitcode~ (integer)

Empty collections are encoded as arrays (not ~null~).

** Exit Codes

| Code | Meaning |
| ~0~ | Success |
| ~1~ | Runtime failure |
| ~2~ | Invalid arguments |
| ~3~ | Emacs server unavailable |
| ~4~ | Validation failed |

* Events and Hooks
:PROPERTIES:
:CUSTOM_ID: events-and-hooks
:END:

** Unified Event Hook

~supervisor-event-hook~ receives one plist per event:

- ~:type~ (symbol)
- ~:ts~ (float timestamp)
- ~:id~ (string or ~nil~)
- ~:stage~ (symbol or ~nil~)
- ~:data~ (plist)

Event types:

- ~stage-start~
- ~stage-complete~
- ~process-started~
- ~process-ready~
- ~process-exit~
- ~process-failed~
- ~cleanup~
- ~timer-trigger~
- ~timer-overlap~
- ~timer-success~
- ~timer-failure~

** Legacy Compatibility Hooks

Still supported and dispatched from event adapter:

- ~supervisor-cleanup-hook~
- ~supervisor-stage-start-hook~
- ~supervisor-stage-complete-hook~
- ~supervisor-process-exit-hook~ (~id~, ~status~, ~code~)

* Persistence and Files
:PROPERTIES:
:CUSTOM_ID: persistence-and-files
:END:

** Log Files

- Supervisor-level log file (optional):
- ~<supervisor-log-directory>/supervisor.log~ (controlled by ~supervisor-log-to-file~)
- Per-process logs:
- ~<supervisor-log-directory>/log-<id>.log~ (controlled per service logging policy)

Existing ~log-*.log~ files are rotated on ~supervisor-start~.

** Logging Semantics

~supervisor--log~ emits levels:

- ~error~ and ~warning~ are always shown in minibuffer/log output.
- ~info~ is shown when ~supervisor-verbose~ is non-nil.
- When ~supervisor-log-to-file~ is non-nil, all levels are written to
  ~supervisor.log~ regardless of ~supervisor-verbose~.

** Overrides File

- Path: ~supervisor-overrides-file~
- Default: ~${XDG_STATE_HOME}/supervisor/overrides.eld~ if ~XDG_STATE_HOME~ is
  set, otherwise ~~/.local/state/supervisor/overrides.eld~
- Format: schema-versioned Elisp data

** Timer State File

- Path: ~supervisor-timer-state-file~
- Default: ~${XDG_STATE_HOME}/supervisor/timer-state.eld~ if ~XDG_STATE_HOME~ is
  set, otherwise ~~/.local/state/supervisor/timer-state.eld~
- Active only when timer subsystem is active

* Customization Reference
:PROPERTIES:
:CUSTOM_ID: customization-reference
:END:

All user options (defcustom) are listed below.

** Core Options

| Variable | Default | Purpose |
| ~supervisor-programs~ | ~nil~ | Service definition list |
| ~supervisor-timers~ | ~nil~ | Timer definition list |
| ~supervisor-log-directory~ | ~(expand-file-name "supervisor" user-emacs-directory)~ | Log directory |
| ~supervisor-restart-delay~ | ~2~ | Restart delay (seconds) |
| ~supervisor-max-restarts~ | ~3~ | Crash-loop threshold |
| ~supervisor-restart-window~ | ~60~ | Crash-loop time window (seconds) |
| ~supervisor-shutdown-timeout~ | ~3~ | Graceful shutdown timeout |
| ~supervisor-oneshot-default-wait~ | ~t~ | Default oneshot blocking behavior |
| ~supervisor-oneshot-timeout~ | ~30~ | Default oneshot timeout |
| ~supervisor-stage-timeout~ | ~nil~ | Per-stage timeout (~nil~ means disabled) |
| ~supervisor-max-concurrent-starts~ | ~nil~ | Max concurrent stage spawns |
| ~supervisor-verbose~ | ~nil~ | Show info-level messages |
| ~supervisor-log-to-file~ | ~nil~ | Write supervisor events to file |
| ~supervisor-watch-config~ | ~nil~ | Config file watch/reload |
| ~supervisor-overrides-file~ | ~(XDG_STATE_HOME or ~/.local/state)/supervisor/overrides.eld~ | Override persistence path |

** Timer Options

| Variable | Default | Purpose |
| ~supervisor-timer-state-file~ | ~(XDG_STATE_HOME or ~/.local/state)/supervisor/timer-state.eld~ | Timer state persistence path |
| ~supervisor-timer-retry-intervals~ | ~'(30 120 600)~ | Retry schedule |
| ~supervisor-timer-catch-up-limit~ | ~(* 24 60 60)~ | Catch-up lookback window |

** Dashboard Options

| Variable | Default | Purpose |
| ~supervisor-stage-descriptions~ | ~((stage1 . "X Setup") (stage2 . "System") (stage3 . "Services") (stage4 . "Applets"))~ | Stage labels |
| ~supervisor-dashboard-group-by-stage~ | ~t~ | Group rows by stage |
| ~supervisor-dashboard-show-header-hints~ | ~nil~ | Show header key hint line |
| ~supervisor-dashboard-show-timers~ | ~t~ | Show timer section |
| ~supervisor-auto-refresh-interval~ | ~2~ | Auto-refresh cadence |

* Command Reference
:PROPERTIES:
:CUSTOM_ID: command-reference
:END:

** Interactive Emacs Commands

| Command | Purpose |
| ~M-x supervisor-mode~ | Global supervisor mode (start/stop + file watch) |
| ~M-x supervisor-timer-subsystem-mode~ | Toggle experimental timer subsystem gate |
| ~M-x supervisor-start~ | Build plan and start staged scheduler |
| ~M-x supervisor-stop~ | Async graceful stop |
| ~M-x supervisor-stop-now~ | Sync hard stop |
| ~M-x supervisor-reload~ | Reconcile running state against config |
| ~M-x supervisor-validate~ | Validate config without start |
| ~M-x supervisor-dry-run~ | Show execution plan without start |
| ~M-x supervisor-migrate-config~ | Emit canonical schema v1 config |
| ~M-x supervisor-overrides-load~ | Load overrides from disk |
| ~M-x supervisor-overrides-save~ | Save overrides to disk |
| ~M-x supervisor-overrides-clear~ | Clear overrides in memory + file |
| ~M-x supervisor~ | Open dashboard |
| ~M-x supervisor-handbook~ | Open README.org handbook (read-only) |

** Dashboard Interactive Commands

| Command | Purpose |
| ~M-x supervisor-dashboard-refresh~ | Refresh dashboard buffer |
| ~M-x supervisor-dashboard-cycle-filter~ | Cycle stage filter |
| ~M-x supervisor-dashboard-cycle-tag-filter~ | Cycle tag filter |
| ~M-x supervisor-dashboard-describe-entry~ | Describe selected row |
| ~M-x supervisor-dashboard-help~ | Open dashboard help |
| ~M-x supervisor-dashboard-toggle-auto-refresh~ | Toggle auto-refresh |
| ~M-x supervisor-dashboard-quit~ | Quit dashboard |
| ~M-x supervisor-dashboard-toggle-restart~ | Toggle restart override |
| ~M-x supervisor-dashboard-toggle-enabled~ | Toggle enabled override |
| ~M-x supervisor-dashboard-kill~ | Kill selected service (confirm) |
| ~M-x supervisor-dashboard-kill-force~ | Kill selected service (no confirm) |
| ~M-x supervisor-dashboard-start~ | Start selected service |
| ~M-x supervisor-dashboard-toggle-logging~ | Toggle logging override |
| ~M-x supervisor-dashboard-view-log~ | Open selected service log |
| ~M-x supervisor-dashboard-toggle-proced-auto-update~ | Toggle proced auto-update |
| ~M-x supervisor-dashboard-show-deps~ | Show selected service deps |
| ~M-x supervisor-dashboard-blame~ | Show startup timing view |
| ~M-x supervisor-dashboard-show-graph~ | Show full dependency graph |
| ~M-x supervisor-dashboard-menu-open~ | Open transient menu |

* Indexes
:PROPERTIES:
:CUSTOM_ID: indexes
:END:

This is a topical index for targeted lookup of less-obvious behavior.

** Topical Index

- Async oneshots (~:async~, ~:oneshot-wait~): [[#service-definition-handbook-supervisor-programs][Service Definition Handbook]], [[#startup-and-lifecycle-model][Startup and Lifecycle Model]]
- Blocking oneshot timeout (~:oneshot-timeout~, ~supervisor-oneshot-timeout~): [[#service-definition-handbook-supervisor-programs][Service Definition Handbook]], [[#startup-and-lifecycle-model][Startup and Lifecycle Model]], [[#customization-reference][Customization Reference]]
- Command parsing (no implicit shell, use ~sh -c~ when needed): [[#startup-and-lifecycle-model][Startup and Lifecycle Model]]
- Config file watch and debounce (~supervisor-watch-config~): [[#persistence-and-files][Persistence and Files]], [[#customization-reference][Customization Reference]]
- Crash-loop detection (~supervisor-max-restarts~, ~supervisor-restart-window~): [[#startup-and-lifecycle-model][Startup and Lifecycle Model]], [[#customization-reference][Customization Reference]]
- Cycle fallback behavior for dependencies: [[#service-definition-handbook-supervisor-programs][Service Definition Handbook]], [[#startup-and-lifecycle-model][Startup and Lifecycle Model]]
- Dashboard filtering (stage/tag): [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook (~M-x supervisor~)]]
- Dashboard live updates (~supervisor-auto-refresh-interval~): [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook (~M-x supervisor~)]], [[#customization-reference][Customization Reference]]
- Dashboard mode/filter state (buffer-local stage/tag/auto-refresh): [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook (~M-x supervisor~)]]
- Dashboard visual customization (status/type/stage faces): [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook (~M-x supervisor~)]]
- Dependency semantics split (~:after~ vs ~:requires~): [[#service-definition-handbook-supervisor-programs][Service Definition Handbook]]
- Event API (~supervisor-event-hook~ and event types): [[#events-and-hooks][Events and Hooks]]
- Exit code semantics for oneshots (signals stored negative): [[#startup-and-lifecycle-model][Startup and Lifecycle Model]]
- Graceful vs hard stop (~supervisor-stop~ vs ~supervisor-stop-now~): [[#startup-and-lifecycle-model][Startup and Lifecycle Model]], [[#command-reference][Command Reference]]
- Hyphen-prefixed IDs in CLI (use ~--~ separator): [[#cli-handbook-sbinsupervisorctl][CLI Handbook (~sbin/supervisorctl~)]]
- JSON contracts (status/validate/timers + error shape): [[#cli-handbook-sbinsupervisorctl][CLI Handbook (~sbin/supervisorctl~)]]
- Log rotation and log file paths: [[#persistence-and-files][Persistence and Files]], [[#customization-reference][Customization Reference]]
- Logging pipeline (~supervisor--log~, ~supervisor-verbose~, ~supervisor-log-to-file~): [[#persistence-and-files][Persistence and Files]], [[#customization-reference][Customization Reference]]
- Manual stop behavior and restart suppression: [[#startup-and-lifecycle-model][Startup and Lifecycle Model]], [[#runtime-overrides-and-reconciliation][Runtime Overrides and Reconciliation]]
- Max concurrent stage starts (~supervisor-max-concurrent-starts~): [[#startup-and-lifecycle-model][Startup and Lifecycle Model]], [[#customization-reference][Customization Reference]]
- Override precedence (runtime override vs config default): [[#runtime-overrides-and-reconciliation][Runtime Overrides and Reconciliation]]
- Override persistence (~supervisor-overrides-file~): [[#runtime-overrides-and-reconciliation][Runtime Overrides and Reconciliation]], [[#persistence-and-files][Persistence and Files]]
- Reload reconciler action model (~start~, ~stop~, ~noop~, ~skip~): [[#runtime-overrides-and-reconciliation][Runtime Overrides and Reconciliation]]
- Security boundary (~emacsclient --eval~, server socket trust): [[#security][Security]]
- Wrapper help vs no-command usage text: [[#cli-handbook-sbinsupervisorctl][CLI Handbook (~sbin/supervisorctl~)]]
- Stage timeout force-complete (~supervisor-stage-timeout~): [[#startup-and-lifecycle-model][Startup and Lifecycle Model]], [[#customization-reference][Customization Reference]]
- Timer catch-up window (~supervisor-timer-catch-up-limit~, ~:persistent~): [[#timer-subsystem-handbook-experimental][Timer Subsystem Handbook (Experimental)]], [[#customization-reference][Customization Reference]]
- Timer disabled/gated behavior (~supervisor-timer-subsystem-mode~ + parent mode): [[#timer-subsystem-handbook-experimental][Timer Subsystem Handbook (Experimental)]], [[#command-reference][Command Reference]]
- Timer miss reasons (~overlap~, ~disabled~, ~disabled-target~): [[#timer-subsystem-handbook-experimental][Timer Subsystem Handbook (Experimental)]], [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook (~M-x supervisor~)]]
- Timer retry policy (~supervisor-timer-retry-intervals~, signal non-retry): [[#timer-subsystem-handbook-experimental][Timer Subsystem Handbook (Experimental)]], [[#customization-reference][Customization Reference]]
- Timer state persistence and schema compatibility (~supervisor-timer-state-file~): [[#timer-subsystem-handbook-experimental][Timer Subsystem Handbook (Experimental)]], [[#persistence-and-files][Persistence and Files]]

* Security
:PROPERTIES:
:CUSTOM_ID: security
:END:

~supervisorctl~ uses ~emacsclient --eval~. Any principal that can connect to
your Emacs server can execute code as your Emacs user.

Security boundary: your Emacs server socket/server-file access controls.

Practical guidance:

- Prefer local socket transport.
- Use ~--server-file~ only when you intentionally operate server-file/TCP mode.
- Keep server auth/socket directories private (owner-only permissions).

* Development
:PROPERTIES:
:CUSTOM_ID: development
:END:

#+begin_src bash
make check
make lint
make test
make test-one TEST=supervisor-test-parse-string-entry
#+end_src

Interactive load:

#+begin_src bash
emacs -Q -l supervisor.el
#+end_src

* License
:PROPERTIES:
:CUSTOM_ID: license
:END:

GPL-3.0-or-later. See ~LICENSE~.
