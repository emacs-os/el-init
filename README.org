[[https://github.com/cypherpunk2001/supervisor.el/actions/workflows/ci.yml][https://github.com/cypherpunk2001/supervisor.el/actions/workflows/ci.yml/badge.svg]]

* supervisor.el Handbook

A userspace service manager for Emacs sessions.

~supervisor.el~ provides deterministic process supervision, staged startup,
dependency ordering, crash recovery, interactive operations, CLI control, and
an experimental timer subsystem for scheduled ~oneshot~ services.

This handbook is the implementation reference for current behavior.

* Navigation

- [[#scope-and-goals][Scope and Goals]]
- [[#module-layout][Module Layout]]
- [[#requirements][Requirements]]
- [[#quick-start][Quick Start]]
- [[#service-definition-handbook-supervisor-programs][Service Definition Handbook (~supervisor-programs~)]]
- [[#startup-and-lifecycle-model][Startup and Lifecycle Model]]
- [[#runtime-overrides-and-reconciliation][Runtime Overrides and Reconciliation]]
- [[#timer-subsystem-handbook-experimental][Timer Subsystem Handbook (Experimental)]]
- [[#dashboard-handbook-m-x-supervisor][Dashboard Handbook (~M-x supervisor~)]]
- [[#cli-handbook-sbinsupervisorctl][CLI Handbook (~sbin/supervisorctl~)]]
- [[#events-and-hooks][Events and Hooks]]
- [[#persistence-and-files][Persistence and Files]]
- [[#customization-reference][Customization Reference]]
- [[#command-reference][Command Reference]]
- [[#indexes][Indexes]]
- [[#security][Security]]
- [[#development][Development]]
- [[#license][License]]

<<scope-and-goals>>
* Scope and Goals

~supervisor.el~ is a *per-user session supervisor*.

It is designed for long-lived Emacs sessions (for example EXWM or daemon +
emacsclient workflows) where you want to define and manage session services in
Elisp.

It is not a system init replacement in current release scope.

<<module-layout>>
* Module Layout

| File | Purpose |
| ~supervisor.el~ | Facade; loads all modules and provides feature ~supervisor~ |
| ~supervisor-core.el~ | Engine: parsing, validation, planning, DAG scheduler, lifecycle, overrides |
| ~supervisor-timer.el~ | Experimental timer subsystem: timers, scheduler, retry/catch-up, timer state |
| ~supervisor-dashboard.el~ | Dashboard UI, keybindings, transient menu integration |
| ~supervisor-cli.el~ | CLI parser/dispatcher/formatters and wrapper adapter |
| ~sbin/supervisorctl~ | Transport wrapper around ~emacsclient --eval~ |

Load order in facade: core -> timer -> dashboard -> cli.

Module dependency rules:

- ~supervisor-core.el~ has no hard dependency on dashboard or CLI.
- ~supervisor-timer.el~ depends on core.
- ~supervisor-dashboard.el~ depends on core (+ optional timer symbols).
- ~supervisor-cli.el~ depends on core (+ optional timer symbols).

<<requirements>>
* Requirements

- Emacs 28.1+
- Optional: ~transient~ for dashboard menu key ~?~
- For CLI wrapper: ~emacsclient~, ~base64~, and ~sed~ in ~PATH~

<<quick-start>>
* Quick Start

#+begin_src emacs-lisp
(require 'supervisor)

(setq supervisor-programs
      '(("xsetroot -cursor_name left_ptr" :type oneshot :stage stage1 :id "cursor")
        ("/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1"
         :type simple :stage stage2 :id "polkit" :restart t)
        ("nm-applet" :type simple :stage stage3 :id "nm" :restart t)
        ("pasystray" :type simple :stage stage4 :id "tray" :restart t)))

(supervisor-mode 1)
#+end_src

Suggested hooks when Emacs is your session owner:

#+begin_src emacs-lisp
(add-hook 'elpaca-after-init-hook #'supervisor-start)
(add-hook 'kill-emacs-hook #'supervisor-stop-now)
#+end_src

Enable the experimental timer subsystem only if you are using timers:

#+begin_src emacs-lisp
;; Parent mode must also be on.
(supervisor-mode 1)
(supervisor-timer-subsystem-mode 1)
#+end_src

<<service-definition-handbook-supervisor-programs>>
* Service Definition Handbook (~supervisor-programs~)

~supervisor-programs~ is a list of entries.

Entry forms:

- Command string: ~"nm-applet"~
- Command + plist: ~("nm-applet" :id "nm" :stage stage3 ...)~

** Entry Keywords

| Keyword | Type | Default | Notes |
| ~:id~ | string | basename of executable token | Must be string if provided |
| ~:type~ | symbol | ~simple~ | ~simple~ or ~oneshot~ |
| ~:stage~ | symbol | ~stage3~ | ~stage1~, ~stage2~, ~stage3~, ~stage4~ |
| ~:delay~ | non-negative number | ~0~ | Delays spawn in seconds |
| ~:after~ | string or list of strings | ~nil~ | Ordering dependency (same stage) |
| ~:requires~ | string or list of strings | ~nil~ | Requirement + ordering dependency (same stage) |
| ~:enabled~ | boolean | ~t~ | Enable/disable service |
| ~:disabled~ | boolean | ~nil~ | Inverse form of ~:enabled~ |
| ~:restart~ | boolean | ~t~ | For ~simple~ only |
| ~:no-restart~ | boolean | ~nil~ | Inverse form of ~:restart~ |
| ~:logging~ | boolean | ~t~ | Per-process log capture |
| ~:oneshot-wait~ | boolean | ~supervisor-oneshot-default-wait~ | For ~oneshot~ only |
| ~:async~ | boolean | ~nil~ | Alias for non-blocking oneshot (~not :oneshot-wait~) |
| ~:oneshot-timeout~ | number or ~nil~ | ~supervisor-oneshot-timeout~ | For ~oneshot~ only |
| ~:tags~ | symbol, string, or list | ~nil~ | Dashboard tag filtering |

** Validation Rules

Validation is performed by ~supervisor--validate-entry~ and plan building.

- Unknown keywords are rejected.
- ~:id~ must be a string when present.
- ~:type~ must be symbol ~simple~ or ~oneshot~.
- ~:stage~ must be symbol ~stage1..stage4~.
- ~:delay~ must be non-negative number.
- ~:oneshot-timeout~ must be number or ~nil~.
- ~:after~ and ~:requires~ must be string or proper list of strings.
- Mutually exclusive pairs are rejected:
- ~:enabled~ with ~:disabled~
- ~:restart~ with ~:no-restart~
- ~:oneshot-wait~ with ~:async~
- Type restrictions are enforced:
- ~oneshot~ rejects ~:restart~ and ~:no-restart~
- ~simple~ rejects ~:oneshot-wait~, ~:async~, ~:oneshot-timeout~

Invalid entries are skipped at start/reload and shown as ~invalid~ in dashboard
and CLI status/validate output.

** ID Resolution and Duplicate Handling

ID resolution for string entries uses the basename of the first command token
(after ~split-string-and-unquote~).

Duplicate IDs are deterministic:

- First valid occurrence wins.
- Later duplicates are skipped with warning.

** Dependency Semantics: ~:after~ vs ~:requires~

- ~:after~: ordering only.
- ~:requires~: pull-in + ordering.

Planner rules:

- Both are constrained to same-stage dependencies.
- Cross-stage ~:after~ is ignored with warning.
- Cross-stage ~:requires~ is an error (entry invalid).
- Missing dependencies are ignored with warning.
- Topological sort uses stable list order as tie-break.
- Cycle fallback clears dependency edges for affected stage and falls back to
  deterministic list order.

** Internal Normalized Shape

Valid entries are normalized to schema v1 tuple form:

#+begin_src elisp
(id cmd delay enabled-p restart-p logging-p type stage after
    oneshot-wait oneshot-timeout tags requires)
#+end_src

Accessor functions (~supervisor-entry-id~, ~supervisor-entry-command~, etc.) are
the canonical way to read entry fields.

** Validation and Dry-Run Commands

~M-x supervisor-validate~:

- validates services
- validates timers when timer module is available
- populates invalid hashes for dashboard/CLI visibility
- opens ~*supervisor-validate*~ report buffer

~M-x supervisor-dry-run~:

- builds plan without starting processes
- prints stage order and resolved dependency metadata
- prints timer validation summary when timers are configured
- opens ~*supervisor-dry-run*~ report buffer

<<startup-and-lifecycle-model>>
* Startup and Lifecycle Model

** Stages and Ordering

Stage order is fixed:

- ~stage1~
- ~stage2~
- ~stage3~
- ~stage4~

Stages execute sequentially; entries inside a stage execute in dependency order,
with parallelism allowed where dependencies permit.

** Async DAG Scheduler Semantics

Within a stage:

- In-degree 0 entries are eligible to start.
- Dependents unlock when prerequisites become ready.
- Disabled entries are marked ready immediately.
- Start failures mark ready immediately (do not block graph).
- Optional ~supervisor-max-concurrent-starts~ limits active spawn attempts.

Ready semantics:

- ~simple~: ready when process spawns.
- ~oneshot~: ready on exit (success/failure) or timeout.

Stage completion requires all of:

- all entries started/skipped/failed-to-spawn,
- no pending delay timers,
- no pending blocking oneshots.

** Lifecycle State Machine

Per-entry runtime state is tracked in ~supervisor--entry-state~.

States:

- ~stage-not-started~
- ~waiting-on-deps~
- ~delayed~
- ~disabled~
- ~started~
- ~failed-to-spawn~
- ~stage-timeout~

Invalid transitions signal errors unless forced by internal maintenance paths.

** Process Spawn and Command Execution

Processes are created via ~make-process~.

- Command arguments are parsed by ~split-string-and-unquote~.
- No implicit shell is used.
- Use explicit shell (~sh -c ...~) if shell semantics are required.

** Restart and Crash Loop Policy (~simple~)

Restart behavior is controlled by effective restart policy
(config + runtime override).

- Delay: ~supervisor-restart-delay~
- Window: ~supervisor-restart-window~ seconds
- Threshold: ~supervisor-max-restarts~
- On crash-loop threshold, service is marked failed (~dead~) and restart stops.

~oneshot~ services are not auto-restarted.

** Oneshot Exit Encoding

For oneshot completion tracking (~supervisor--oneshot-completed~):

- normal exit stores exit code (~0~, ~1~, ...)
- signal death stores negative signal number (~SIGKILL~ -> ~-9~)

This is used by status/reporting and timer retry eligibility.

** Stop Semantics

~supervisor-stop~ (async graceful):

- sends ~SIGTERM~
- waits asynchronously for exits
- after ~supervisor-shutdown-timeout~, sends ~SIGKILL~ to survivors

~supervisor-stop-now~ (sync hard stop):

- sends immediate ~SIGKILL~
- waits up to ~0.5s~ for process death
- intended for ~kill-emacs-hook~

<<runtime-overrides-and-reconciliation>>
* Runtime Overrides and Reconciliation

** Runtime Overrides

Three override tables are supported:

- enabled override (~supervisor--enabled-override~)
- restart override (~supervisor--restart-override~)
- logging override (~supervisor--logging~)

Effective value resolution is:

- explicit runtime override if present,
- otherwise config default.

** Persistence of Overrides

Overrides are persisted in ~supervisor-overrides-file~.

- Saved with atomic write (temp file + rename)
- Loaded on ~supervisor-start~
- Corrupt file is logged and preserved

Interactive helpers:

- ~M-x supervisor-overrides-load~
- ~M-x supervisor-overrides-save~
- ~M-x supervisor-overrides-clear~

Dashboard toggles for enabled/restart persist immediately.
Dashboard logging toggle updates runtime state; use explicit save command (or CLI
logging command) when you want persistence written immediately.

** Reload Reconciler (~supervisor-reload~)

Reconcile flow:

1. Build plan
2. Build runtime snapshot
3. Compute actions (~start~, ~stop~, ~noop~, ~skip~)
4. Apply actions

Effects:

- Stops removed entries
- Stops entries now effectively disabled
- Starts newly eligible entries
- Leaves converged entries running

<<timer-subsystem-handbook-experimental>>
* Timer Subsystem Handbook (Experimental)

Timer subsystem lives in ~supervisor-timer.el~ and is disabled by default.

** Gating Contract

Timer subsystem is active only when both are true:

- ~supervisor-mode~ is enabled
- ~supervisor-timer-subsystem-mode~ is enabled

If gate is inactive, timer scheduler side effects do not run.

** Timer Configuration (~supervisor-timers~)

Each timer is a plist.

Required keys:

- ~:id~ (non-empty string)
- ~:target~ (non-empty string; must resolve to a ~oneshot~ service)

Trigger keys (at least one required):

- ~:on-calendar~
- ~:on-startup-sec~
- ~:on-unit-active-sec~

Optional keys:

- ~:enabled~ (boolean, default ~t~)
- ~:persistent~ (boolean, default ~t~)

#+begin_src emacs-lisp
(setq supervisor-timers
      '((:id "daily-backup"
         :target "backup-oneshot"
         :on-calendar (:hour 3 :minute 0)
         :persistent t)
        (:id "warm-cache"
         :target "cache-prime"
         :on-startup-sec 45)
        (:id "sync-loop"
         :target "sync-oneshot"
         :on-unit-active-sec 300)))
#+end_src

** Calendar Trigger Format

~:on-calendar~ accepts either:

- single plist, or
- list of plists (earliest next match wins)

Allowed fields:

- ~:minute~ (0..59)
- ~:hour~ (0..23)
- ~:day-of-month~ (1..31)
- ~:month~ (1..12)
- ~:day-of-week~ (0..6)

Field values:

- integer
- non-empty list of integers
- ~*~ wildcard

Semantics:

- next run is computed strictly after current time
- day-by-day search with bounded horizon (28-year cycle coverage)
- DST gaps are handled by validating encoded/decoded wall clock fields

** Trigger Semantics

~:on-startup-sec~:

- positive integer seconds after scheduler startup
- fires once per supervisor session

~:on-unit-active-sec~:

- positive integer seconds after last successful target completion

Combined timers:

- scheduler chooses earliest due trigger among configured trigger types

** Overlap, Disable, and Missing-Target Behavior

When due:

- Disabled timer -> skipped, miss reason ~disabled~
- Active target oneshot -> skipped, miss reason ~overlap~
- Disabled target service -> skipped, miss reason ~disabled-target~
- Missing target entry -> warning, no trigger

Miss metadata is stored in timer state.

** Retry Policy

Configured by ~supervisor-timer-retry-intervals~ (default ~'(30 120 600)~).

- Retryable failures: positive exit codes only
- Non-retryable: signal deaths (negative stored exit codes), nil, and zero
- Retry budget resets on fresh scheduled runs

** Catch-up Policy

Configured by:

- ~:persistent~ per timer (default ~t~)
- ~supervisor-timer-catch-up-limit~ in seconds (default 24h)

On scheduler start, persistent timers may trigger catch-up runs for missed
schedules within the configured window.

** Timer Persistence

Timer runtime state file: ~supervisor-timer-state-file~.

- Atomic writes (temp + rename)
- Schema versioned
- Newer incompatible schema versions are rejected
- Stale timer IDs are pruned when scheduler starts

Persisted keys include:

- ~:last-run-at~
- ~:last-success-at~
- ~:last-failure-at~
- ~:last-exit~
- ~:last-missed-at~
- ~:last-miss-reason~

Transient keys (for example ~:next-run-at~, retry bookkeeping, startup-consumed
state) are recomputed each session.

** Timer Scheduler Lifecycle

- Started after all service stages complete
- Stopped on ~supervisor-stop~, ~supervisor-stop-now~, and when timer mode is disabled
- Uses ~run-at-time~ scheduling (no polling loop)

** Timer Visibility Surfaces

Dashboard:

- Timer section is shown only when
- ~supervisor-dashboard-show-timers~ is non-nil
- timer subsystem is active
- there are timer rows or invalid timer definitions

CLI:

- ~supervisorctl timers~ shows timer runtime/invalid definitions
- If subsystem is gated off, command returns explicit disabled status

<<dashboard-handbook-m-x-supervisor>>
* Dashboard Handbook (~M-x supervisor~)

Dashboard buffer: ~*supervisor*~, major mode ~supervisor-dashboard-mode~
(derived from ~tabulated-list-mode~).

** Service Columns

- ~ID~
- ~Type~
- ~Stage~
- ~Enabled~
- ~Status~
- ~Restart~
- ~Log~
- ~PID~
- ~Reason~

** Service Status Values

- ~running~
- ~done~
- ~failed~
- ~dead~
- ~pending~
- ~stopped~
- ~invalid~

** Service Reason Values

- ~disabled~
- ~delayed~
- ~waiting-on-deps~
- ~stage-not-started~
- ~failed-to-spawn~
- ~stage-timeout~
- ~crash-loop~

** Timer Rows in Dashboard

Timer rows are informational and use timer runtime state.

Timer row status values:

- ~active~ (target currently running)
- ~done~ (last exit ~0~)
- ~failed~ (last exit non-zero)
- ~pending~ (no completion yet)

Timer reason column shows either:

- ~missed: <reason>~, or
- ~next: <relative time>~

** Dashboard Keymap

| Key | Function |
| ~e~ | Toggle enabled override |
| ~f~ | Cycle stage filter |
| ~t~ | Cycle tag filter |
| ~s~ | Start selected service |
| ~k~ | Kill selected service (confirm) |
| ~K~ | Kill selected service (force) |
| ~r~ | Toggle restart override |
| ~l~ | Toggle logging override |
| ~L~ | Open selected service log file |
| ~p~ | Open ~proced~ |
| ~P~ | Toggle proced auto-update |
| ~d~ | Show dependencies for selected service |
| ~D~ | Show full dependency graph |
| ~B~ | Show startup blame timings |
| ~g~ | Refresh dashboard |
| ~G~ | Toggle auto-refresh |
| ~?~ | Open transient action menu |
| ~i~ | Describe row (~C-u i~ shows status legend) |
| ~h~ | Open dashboard help buffer |
| ~q~ | Quit dashboard |

Notes:

- Separator rows reject service actions.
- ~?~ requires the ~transient~ package.
- Full ID is echoed in minibuffer when current row ID exceeds table width.

<<cli-handbook-sbinsupervisorctl>>
* CLI Handbook (~sbin/supervisorctl~)

The shell wrapper is transport-only; behavior is implemented in
~supervisor-cli.el~ dispatchers.

** Wrapper Syntax

#+begin_src bash
sbin/supervisorctl [WRAPPER-OPTIONS] COMMAND [COMMAND-ARGS]
#+end_src

** Wrapper Options

| Option | Notes |
| ~--help~, ~-h~ | Show wrapper help |
| ~--json~ | Request JSON output from CLI dispatcher |
| ~--socket NAME~, ~--socket-name NAME~, ~-s NAME~ | Use specific local socket |
| ~--server-file PATH~, ~-f PATH~ | Use server file transport |
| ~--timeout N~, ~-t N~ | Pass wait timeout to ~emacsclient -w~ |

Wrapper transport rules:

- ~--socket~ and ~--server-file~ are mutually exclusive.
- ~--server-file~ emits a TCP transport warning.

** CLI Commands

Lifecycle:

- ~status [ID...]~
- ~list [ID...]~ (alias of ~status~)
- ~describe ID~
- ~start [-- ID...]~
- ~stop [-- ID...]~
- ~restart [-- ID...]~
- ~reload~
- ~validate~

Overrides and policy:

- ~enable [--] ID...~
- ~disable [--] ID...~
- ~restart-policy (on|off) [--] ID...~
- ~logging (on|off) [--] ID...~

Inspection and utilities:

- ~blame~
- ~graph [ID]~
- ~logs [--tail N] [--] ID~
- ~kill [--signal SIG] [--] ID~
- ~ping~
- ~version~
- ~timers~

Use ~--~ before IDs that start with ~-~ for commands that accept positional
IDs.

** Command Notes

~validate~:

- returns exit code ~4~ if service or timer validation errors exist
- returns both service and timer invalid sets

~start~, ~stop~, ~restart~:

- with IDs: operate on those IDs
- with no IDs: operate on whole supervisor (~start~, ~stop-now~, ~stop-now+start~)

~graph~:

- no ID: full edge list
- with ID: after/requires/blocks for that ID

~timers~:

- explicit disabled response when timer subsystem is gated off

** Output Formats

Human format is default.

~--json~ returns stable object structures per command (for example status,
validate, graph, timers).

Status JSON top-level keys:

- ~entries~ (array)
- ~invalid~ (array)

Timer JSON top-level keys:

- ~timers~ (array)
- ~invalid~ (array)

Validation JSON top-level keys:

- ~services~ with ~valid~, ~invalid~, ~errors~
- ~timers~ with ~valid~, ~invalid~, ~errors~

Error JSON shape (for argument/runtime errors):

- ~error~ (boolean)
- ~message~ (string)
- ~exitcode~ (integer)

Empty collections are encoded as arrays (not ~null~).

** Exit Codes

| Code | Meaning |
| ~0~ | Success |
| ~1~ | Runtime failure |
| ~2~ | Invalid arguments |
| ~3~ | Emacs server unavailable |
| ~4~ | Validation failed |

<<events-and-hooks>>
* Events and Hooks

** Unified Event Hook

~supervisor-event-hook~ receives one plist per event:

- ~:type~ (symbol)
- ~:ts~ (float timestamp)
- ~:id~ (string or ~nil~)
- ~:stage~ (symbol or ~nil~)
- ~:data~ (plist)

Event types:

- ~stage-start~
- ~stage-complete~
- ~process-started~
- ~process-ready~
- ~process-exit~
- ~process-failed~
- ~cleanup~
- ~timer-trigger~
- ~timer-overlap~
- ~timer-success~
- ~timer-failure~

** Legacy Compatibility Hooks

Still supported and dispatched from event adapter:

- ~supervisor-cleanup-hook~
- ~supervisor-stage-start-hook~
- ~supervisor-stage-complete-hook~
- ~supervisor-process-exit-hook~ (~id~, ~status~, ~code~)

<<persistence-and-files>>
* Persistence and Files

** Log Files

- Supervisor-level log file (optional):
- ~<supervisor-log-directory>/supervisor.log~ (controlled by ~supervisor-log-to-file~)
- Per-process logs:
- ~<supervisor-log-directory>/log-<id>.log~ (controlled per service logging policy)

Existing ~log-*.log~ files are rotated on ~supervisor-start~.

** Overrides File

- Path: ~supervisor-overrides-file~
- Default: ~${XDG_STATE_HOME}/supervisor/overrides.eld~ if ~XDG_STATE_HOME~ is
  set, otherwise ~~/.local/state/supervisor/overrides.eld~
- Format: schema-versioned Elisp data

** Timer State File

- Path: ~supervisor-timer-state-file~
- Default: ~${XDG_STATE_HOME}/supervisor/timer-state.eld~ if ~XDG_STATE_HOME~ is
  set, otherwise ~~/.local/state/supervisor/timer-state.eld~
- Active only when timer subsystem is active

<<customization-reference>>
* Customization Reference

All user options (defcustom) are listed below.

** Core Options

| Variable | Default | Purpose |
| ~supervisor-programs~ | ~nil~ | Service definition list |
| ~supervisor-timers~ | ~nil~ | Timer definition list |
| ~supervisor-log-directory~ | ~(expand-file-name "supervisor" user-emacs-directory)~ | Log directory |
| ~supervisor-restart-delay~ | ~2~ | Restart delay (seconds) |
| ~supervisor-max-restarts~ | ~3~ | Crash-loop threshold |
| ~supervisor-restart-window~ | ~60~ | Crash-loop time window (seconds) |
| ~supervisor-shutdown-timeout~ | ~3~ | Graceful shutdown timeout |
| ~supervisor-oneshot-default-wait~ | ~t~ | Default oneshot blocking behavior |
| ~supervisor-oneshot-timeout~ | ~30~ | Default oneshot timeout |
| ~supervisor-stage-timeout~ | ~nil~ | Per-stage timeout |
| ~supervisor-max-concurrent-starts~ | ~nil~ | Max concurrent stage spawns |
| ~supervisor-verbose~ | ~nil~ | Show info-level messages |
| ~supervisor-log-to-file~ | ~nil~ | Write supervisor events to file |
| ~supervisor-watch-config~ | ~nil~ | Config file watch/reload |
| ~supervisor-overrides-file~ | ~(XDG_STATE_HOME or ~/.local/state)/supervisor/overrides.eld~ | Override persistence path |

** Timer Options

| Variable | Default | Purpose |
| ~supervisor-timer-state-file~ | ~(XDG_STATE_HOME or ~/.local/state)/supervisor/timer-state.eld~ | Timer state persistence path |
| ~supervisor-timer-retry-intervals~ | ~'(30 120 600)~ | Retry schedule |
| ~supervisor-timer-catch-up-limit~ | ~(* 24 60 60)~ | Catch-up lookback window |

** Dashboard Options

| Variable | Default | Purpose |
| ~supervisor-stage-descriptions~ | ~((stage1 . "X Setup") (stage2 . "System") (stage3 . "Services") (stage4 . "Applets"))~ | Stage labels |
| ~supervisor-dashboard-group-by-stage~ | ~t~ | Group rows by stage |
| ~supervisor-dashboard-show-header-hints~ | ~nil~ | Show header key hint line |
| ~supervisor-dashboard-show-timers~ | ~t~ | Show timer section |
| ~supervisor-auto-refresh-interval~ | ~2~ | Auto-refresh cadence |

<<command-reference>>
* Command Reference

** Interactive Emacs Commands

| Command | Purpose |
| ~M-x supervisor-mode~ | Global supervisor mode (start/stop + file watch) |
| ~M-x supervisor-timer-subsystem-mode~ | Toggle experimental timer subsystem gate |
| ~M-x supervisor-start~ | Build plan and start staged scheduler |
| ~M-x supervisor-stop~ | Async graceful stop |
| ~M-x supervisor-stop-now~ | Sync hard stop |
| ~M-x supervisor-reload~ | Reconcile running state against config |
| ~M-x supervisor-validate~ | Validate config without start |
| ~M-x supervisor-dry-run~ | Show execution plan without start |
| ~M-x supervisor-migrate-config~ | Emit canonical schema v1 config |
| ~M-x supervisor-overrides-load~ | Load overrides from disk |
| ~M-x supervisor-overrides-save~ | Save overrides to disk |
| ~M-x supervisor-overrides-clear~ | Clear overrides in memory + file |
| ~M-x supervisor~ | Open dashboard |

** Dashboard Interactive Commands

| Command | Purpose |
| ~M-x supervisor-dashboard-refresh~ | Refresh dashboard buffer |
| ~M-x supervisor-dashboard-cycle-filter~ | Cycle stage filter |
| ~M-x supervisor-dashboard-cycle-tag-filter~ | Cycle tag filter |
| ~M-x supervisor-dashboard-describe-entry~ | Describe selected row |
| ~M-x supervisor-dashboard-help~ | Open dashboard help |
| ~M-x supervisor-dashboard-toggle-auto-refresh~ | Toggle auto-refresh |
| ~M-x supervisor-dashboard-quit~ | Quit dashboard |
| ~M-x supervisor-dashboard-toggle-restart~ | Toggle restart override |
| ~M-x supervisor-dashboard-toggle-enabled~ | Toggle enabled override |
| ~M-x supervisor-dashboard-kill~ | Kill selected service (confirm) |
| ~M-x supervisor-dashboard-kill-force~ | Kill selected service (no confirm) |
| ~M-x supervisor-dashboard-start~ | Start selected service |
| ~M-x supervisor-dashboard-toggle-logging~ | Toggle logging override |
| ~M-x supervisor-dashboard-view-log~ | Open selected service log |
| ~M-x supervisor-dashboard-toggle-proced-auto-update~ | Toggle proced auto-update |
| ~M-x supervisor-dashboard-show-deps~ | Show selected service deps |
| ~M-x supervisor-dashboard-blame~ | Show startup timing view |
| ~M-x supervisor-dashboard-show-graph~ | Show full dependency graph |
| ~M-x supervisor-dashboard-menu-open~ | Open transient menu |

<<indexes>>
* Indexes

These indexes are intentionally redundant for searchability.

** Index: Entry Keywords

- ~:id~
- ~:type~
- ~:stage~
- ~:delay~
- ~:after~
- ~:requires~
- ~:enabled~
- ~:disabled~
- ~:restart~
- ~:no-restart~
- ~:logging~
- ~:oneshot-wait~
- ~:async~
- ~:oneshot-timeout~
- ~:tags~

** Index: Timer Keywords

- ~:id~
- ~:target~
- ~:enabled~
- ~:persistent~
- ~:on-calendar~
- ~:on-startup-sec~
- ~:on-unit-active-sec~
- ~:minute~
- ~:hour~
- ~:day-of-month~
- ~:month~
- ~:day-of-week~

** Index: CLI Commands

- ~status~
- ~list~
- ~describe~
- ~start~
- ~stop~
- ~restart~
- ~reload~
- ~validate~
- ~enable~
- ~disable~
- ~restart-policy~
- ~logging~
- ~blame~
- ~graph~
- ~logs~
- ~kill~
- ~ping~
- ~version~
- ~timers~

** Index: Customization Variables

- ~supervisor-programs~
- ~supervisor-timers~
- ~supervisor-log-directory~
- ~supervisor-restart-delay~
- ~supervisor-max-restarts~
- ~supervisor-restart-window~
- ~supervisor-shutdown-timeout~
- ~supervisor-oneshot-default-wait~
- ~supervisor-oneshot-timeout~
- ~supervisor-stage-timeout~
- ~supervisor-max-concurrent-starts~
- ~supervisor-verbose~
- ~supervisor-log-to-file~
- ~supervisor-watch-config~
- ~supervisor-overrides-file~
- ~supervisor-timer-state-file~
- ~supervisor-timer-retry-intervals~
- ~supervisor-timer-catch-up-limit~
- ~supervisor-stage-descriptions~
- ~supervisor-dashboard-group-by-stage~
- ~supervisor-dashboard-show-header-hints~
- ~supervisor-dashboard-show-timers~
- ~supervisor-auto-refresh-interval~

** Index: Hook Variables

- ~supervisor-event-hook~
- ~supervisor-cleanup-hook~
- ~supervisor-stage-start-hook~
- ~supervisor-stage-complete-hook~
- ~supervisor-process-exit-hook~

<<security>>
* Security

~supervisorctl~ uses ~emacsclient --eval~. Any principal that can connect to
your Emacs server can execute code as your Emacs user.

Security boundary: your Emacs server socket/server-file access controls.

Practical guidance:

- Prefer local socket transport.
- Use ~--server-file~ only when you intentionally operate server-file/TCP mode.
- Keep server auth/socket directories private (owner-only permissions).

<<development>>
* Development

#+begin_src bash
make check
make lint
make test
make test-one TEST=supervisor-test-parse-string-entry
#+end_src

Interactive load:

#+begin_src bash
emacs -Q -l supervisor.el
#+end_src

<<license>>
* License

GPL-3.0-or-later. See ~LICENSE~.
