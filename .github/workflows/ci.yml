name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  elisp:
    name: Elisp (Emacs ${{ matrix.emacs-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        emacs-version:
          - '28.2'
          - '29.4'
          - 'snapshot'
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs-version }}

      - name: Install package-lint
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'package-lint)"

      - name: Byte-compile
        run: make byte-compile

      - name: Checkdoc
        run: make checkdoc

      - name: Package-lint
        run: make package-lint

      - name: ERT tests
        run: make test 2>&1 | tee /tmp/ert-output.txt; exit ${PIPESTATUS[0]}

      - name: Update test badge
        if: always() && github.event_name == 'push' && matrix.emacs-version == 'snapshot'
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          LINE=$(grep "^Ran [0-9]" /tmp/ert-output.txt | tail -1)
          TOTAL=$(echo "$LINE" | grep -o '[0-9]* tests' | grep -o '^[0-9]*')
          UNEXPECTED=$(echo "$LINE" | grep -o '[0-9]* unexpected' | grep -o '^[0-9]*')
          UNEXPECTED=${UNEXPECTED:-0}
          if [ "$UNEXPECTED" = "0" ]; then
            COLOR="brightgreen"
            MSG="${TOTAL} passing"
          else
            COLOR="red"
            MSG="${TOTAL} passing, ${UNEXPECTED} failing"
          fi
          curl -s -X PATCH \
            -H "Authorization: token ${GIST_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"files\":{\"elinit-tests.json\":{\"content\":\"{\\\"schemaVersion\\\":1,\\\"label\\\":\\\"tests\\\",\\\"message\\\":\\\"${MSG}\\\",\\\"color\\\":\\\"${COLOR}\\\"}\"}}}" \
            https://api.github.com/gists/e686727a6d88c17c557003e73a9c020c

  c-tests:
    name: C (libexec)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and test
        run: make libexec-check

  shell-tests:
    name: Shell (sbin)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint and test
        run: make sbin-check
